<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Trailing Ivy Caf√©</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=DM+Sans:wght@300;400;500&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<!-- Supabase CDN - reliable UMD build -->
<script src="https://unpkg.com/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
<style>
:root{--cream:#F5EFE4;--warm-white:#FAF7F2;--espresso:#2C1810;--dark-roast:#1A0F0A;--caramel:#C8854A;--latte:#D4A574;--mocha:#6B3F2A;--steam:#E8DDD0;--foam:#F0EAE0;--ivy:#3D6B4A;--ivy-light:#5A8F69;--red:#B85450;--amber:#D4A017;--shadow:rgba(44,24,16,0.12)}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
body{font-family:'DM Sans',sans-serif;background:var(--cream);color:var(--espresso);min-height:100vh}

/* LOGIN */
#login-screen{position:fixed;inset:0;z-index:999;display:flex;align-items:center;justify-content:center;background:linear-gradient(145deg,var(--dark-roast),#2C1810,#1E3A28)}
.login-box{background:var(--warm-white);border-radius:24px;padding:44px 40px;width:92%;max-width:400px;box-shadow:0 32px 80px rgba(0,0,0,0.4);animation:pop .4s cubic-bezier(.34,1.56,.64,1)}
@keyframes pop{from{opacity:0;transform:scale(.9) translateY(20px)}to{opacity:1;transform:none}}
.login-icon{width:60px;height:60px;border-radius:18px;background:linear-gradient(135deg,var(--ivy),var(--espresso));display:flex;align-items:center;justify-content:center;font-size:26px;margin:0 auto 12px;box-shadow:0 8px 24px rgba(61,107,74,.3)}
.login-title{font-family:'Playfair Display',serif;font-size:24px;font-weight:700;text-align:center}
.login-sub{font-size:13px;color:var(--mocha);text-align:center;margin-bottom:24px;font-style:italic}
.role-tabs{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:20px}
.role-tab{padding:11px;border-radius:10px;border:2px solid var(--steam);background:var(--foam);cursor:pointer;text-align:center;transition:all .2s;font-family:'DM Sans',sans-serif}
.role-tab.active{border-color:var(--ivy);background:rgba(61,107,74,.08)}
.role-tab-icon{font-size:20px;display:block;margin-bottom:3px}
.role-tab-name{font-size:13px;font-weight:600}
.role-tab-desc{font-size:11px;color:var(--mocha)}
.lbl{display:block;font-size:11px;font-weight:600;letter-spacing:.6px;text-transform:uppercase;color:var(--mocha);margin-bottom:5px}
.inp{width:100%;background:var(--foam);border:1.5px solid var(--steam);border-radius:10px;padding:11px 14px;font-family:'DM Sans',sans-serif;font-size:14px;color:var(--espresso);outline:none;transition:border .2s;margin-bottom:14px}
.inp:focus{border-color:var(--ivy);box-shadow:0 0 0 3px rgba(61,107,74,.1)}
.login-btn{width:100%;padding:13px;border:none;border-radius:10px;background:linear-gradient(135deg,var(--ivy),#2D5438);color:white;font-family:'DM Sans',sans-serif;font-size:14px;font-weight:600;cursor:pointer;transition:all .2s}
.login-btn:hover{transform:translateY(-1px);box-shadow:0 6px 20px rgba(61,107,74,.35)}
.login-err{background:rgba(184,84,80,.1);color:var(--red);border:1px solid rgba(184,84,80,.2);border-radius:8px;padding:9px 13px;font-size:13px;margin-top:10px;display:none}
.login-hint{font-size:12px;color:var(--mocha);text-align:center;margin-top:14px;line-height:1.6}

/* LOADING */
#loader{position:fixed;inset:0;z-index:500;background:rgba(245,239,228,.92);backdrop-filter:blur(4px);display:none;align-items:center;justify-content:center;flex-direction:column;gap:12px}
#loader.on{display:flex}
.spin{width:38px;height:38px;border:3px solid var(--steam);border-top-color:var(--ivy);border-radius:50%;animation:spin .8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.load-txt{font-size:13px;color:var(--mocha)}

/* APP */
.app{display:flex;flex-direction:column;min-height:100vh}
nav{background:var(--espresso);display:flex;align-items:center;justify-content:space-between;padding:0 24px;height:62px;box-shadow:0 4px 24px rgba(44,24,16,.22);position:sticky;top:0;z-index:100}
.nav-logo{font-family:'Playfair Display',serif;font-size:18px;color:var(--latte);display:flex;align-items:center;gap:8px}
.nav-badge{background:linear-gradient(135deg,var(--ivy),#2D5438);padding:4px 9px;border-radius:6px;font-size:10px;color:rgba(255,255,255,.85);font-family:'DM Sans',sans-serif;font-weight:600;letter-spacing:.5px}
.nav-tabs{display:flex;gap:3px}
.nav-tab{background:none;border:none;cursor:pointer;color:rgba(245,239,228,.5);font-family:'DM Sans',sans-serif;font-size:13px;font-weight:500;padding:7px 14px;border-radius:7px;transition:all .2s}
.nav-tab:hover{color:var(--latte);background:rgba(200,133,74,.1)}
.nav-tab.active{color:var(--cream);background:rgba(200,133,74,.18)}
.nav-right{display:flex;align-items:center;gap:8px}
.nav-user{color:var(--steam);font-size:13px;display:flex;align-items:center;gap:7px}
.avatar{width:32px;height:32px;border-radius:50%;background:linear-gradient(135deg,var(--ivy),var(--espresso));display:flex;align-items:center;justify-content:center;color:var(--cream);font-size:11px;font-weight:700;border:2px solid rgba(61,107,74,.5)}
.logout-btn{background:rgba(184,84,80,.15);border:1px solid rgba(184,84,80,.25);color:#D47470;padding:5px 11px;border-radius:7px;font-size:12px;cursor:pointer;font-family:'DM Sans',sans-serif;transition:all .2s}
.logout-btn:hover{background:rgba(184,84,80,.25)}

main{flex:1;padding:26px 28px;max-width:1380px;margin:0 auto;width:100%}
.panel{display:none}
.panel.active{display:block;animation:fadeIn .3s ease}
@keyframes fadeIn{from{opacity:0;transform:translateY(5px)}to{opacity:1;transform:none}}

/* PAGE HEADER */
.ph{display:flex;align-items:flex-end;justify-content:space-between;margin-bottom:22px}
.pt{font-family:'Playfair Display',serif;font-size:26px;font-weight:700}
.ps{font-size:13px;color:var(--mocha);margin-top:2px}
.dbadge{background:var(--espresso);color:var(--latte);padding:7px 14px;border-radius:20px;font-family:'DM Mono',monospace;font-size:12px}

/* STATS */
.sg{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px;margin-bottom:22px}
.sc{background:var(--warm-white);border:1px solid var(--steam);border-radius:14px;padding:16px 18px;position:relative;overflow:hidden;box-shadow:0 2px 12px var(--shadow);transition:transform .2s}
.sc:hover{transform:translateY(-2px)}
.sc::after{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:linear-gradient(90deg,var(--caramel),var(--latte))}
.sc.g::after{background:linear-gradient(90deg,var(--ivy),var(--ivy-light))}
.sc.r::after{background:linear-gradient(90deg,var(--red),#D47470)}
.sc.a::after{background:linear-gradient(90deg,var(--amber),#E8C44A)}
.sl{font-size:11px;font-weight:600;letter-spacing:.8px;text-transform:uppercase;color:var(--mocha);margin-bottom:6px}
.sv{font-family:'Playfair Display',serif;font-size:28px;line-height:1}
.ss{font-size:12px;color:var(--mocha);margin-top:3px}

/* CARD */
.card{background:var(--warm-white);border:1px solid var(--steam);border-radius:14px;box-shadow:0 2px 14px var(--shadow);overflow:hidden;margin-bottom:18px}
.ch{padding:14px 20px;border-bottom:1px solid var(--steam);display:flex;align-items:center;justify-content:space-between;background:var(--foam)}
.ct{font-family:'Playfair Display',serif;font-size:16px;font-weight:600}
.cb{padding:20px}

/* TABLE */
.tw{overflow-x:auto}
table{width:100%;border-collapse:collapse}
thead th{font-size:11px;font-weight:600;letter-spacing:.8px;text-transform:uppercase;color:var(--mocha);padding:9px 13px;text-align:left;background:var(--foam);border-bottom:1px solid var(--steam)}
tbody td{padding:10px 13px;font-size:14px;border-bottom:1px solid rgba(232,221,208,.5)}
tbody tr:last-child td{border-bottom:none}
tbody tr:hover{background:var(--foam)}

/* BADGE */
.badge{display:inline-flex;align-items:center;gap:4px;padding:3px 9px;border-radius:20px;font-size:12px;font-weight:500}
.bp{background:rgba(61,107,74,.12);color:var(--ivy)}
.ba{background:rgba(184,84,80,.12);color:var(--red)}
.bw{background:rgba(212,160,23,.12);color:var(--amber)}
.bl{background:rgba(200,133,74,.15);color:var(--caramel)}
.br{background:rgba(107,63,42,.1);color:var(--mocha)}

/* BUTTONS */
.btn{border:none;cursor:pointer;border-radius:9px;font-family:'DM Sans',sans-serif;font-weight:500;transition:all .2s;display:inline-flex;align-items:center;gap:5px}
.btn-p{background:var(--espresso);color:var(--cream);padding:9px 18px;font-size:13px}
.btn-p:hover{background:var(--mocha)}
.btn-ivy{background:var(--ivy);color:white;padding:9px 18px;font-size:13px}
.btn-ivy:hover{background:#2D5438}
.btn-sm{padding:5px 12px;font-size:12px;border-radius:7px}
.btn-o{background:none;border:1px solid var(--steam);color:var(--espresso);padding:7px 14px;font-size:12px}
.btn-o:hover{border-color:var(--caramel);color:var(--caramel)}
.btn-g{background:var(--ivy);color:white}
.btn-c{background:var(--caramel);color:white}
.btn-r{background:var(--red);color:white}

/* FORM */
.fg{margin-bottom:14px}
.lbl2{display:block;font-size:11px;font-weight:600;letter-spacing:.4px;text-transform:uppercase;color:var(--mocha);margin-bottom:5px}
.inp2{width:100%;background:var(--foam);border:1px solid var(--steam);border-radius:9px;padding:9px 13px;font-family:'DM Sans',sans-serif;font-size:14px;color:var(--espresso);transition:border .2s;outline:none}
.inp2:focus{border-color:var(--ivy);box-shadow:0 0 0 3px rgba(61,107,74,.1)}
.g2{display:grid;grid-template-columns:1fr 1fr;gap:14px}

/* CLOCK */
.clock{background:linear-gradient(135deg,var(--espresso),#1E3A28);border-radius:18px;padding:24px 28px;color:var(--cream);margin-bottom:20px;display:flex;align-items:center;justify-content:space-between;box-shadow:0 8px 32px rgba(26,15,10,.25);position:relative;overflow:hidden}
.clock::before{content:'üçÉ';position:absolute;right:22px;top:50%;transform:translateY(-50%);font-size:70px;opacity:.05}
.ctime{font-family:'DM Mono',monospace;font-size:42px;letter-spacing:2px;color:var(--latte);line-height:1}
.cdate{font-size:13px;color:rgba(232,221,208,.7);margin-top:4px}
.cactions{display:flex;flex-direction:column;gap:8px;align-items:flex-end}

/* ANNOUNCEMENT */
.ann{background:linear-gradient(135deg,var(--ivy),#2D5438);color:var(--cream);border-radius:12px;padding:13px 16px;margin-bottom:16px;display:flex;align-items:center;gap:10px;box-shadow:0 4px 16px rgba(61,107,74,.25)}
.ann-icon{font-size:17px;flex-shrink:0}
.ann-text{font-size:14px;line-height:1.5}
.ann-text strong{display:block;font-size:11px;letter-spacing:.5px;text-transform:uppercase;opacity:.75;margin-bottom:1px}

/* PROGRESS */
.pb{background:var(--steam);border-radius:99px;height:5px;overflow:hidden;margin-top:5px}
.pf{height:100%;border-radius:99px;background:linear-gradient(90deg,var(--ivy),var(--ivy-light));transition:width .5s ease}

/* LOG */
.le{display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid var(--steam)}
.le:last-child{border-bottom:none}
.ld{width:7px;height:7px;border-radius:50%;flex-shrink:0}
.ldg{background:var(--ivy)}.lda{background:var(--amber)}
.li{flex:1}
.ln{font-size:14px;font-weight:500}
.ldt{font-size:12px;color:var(--mocha)}
.lt{font-family:'DM Mono',monospace;font-size:12px;color:var(--caramel)}

/* PERF */
.pr{display:flex;align-items:center;gap:10px;margin-bottom:10px}
.pn{width:90px;font-size:13px;font-weight:500;flex-shrink:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.pp{width:35px;text-align:right;font-family:'DM Mono',monospace;font-size:12px;color:var(--ivy);flex-shrink:0}

/* FILTER */
.fr{display:flex;gap:9px;align-items:center;flex-wrap:wrap;margin-bottom:16px}
.fr select{width:auto;padding:7px 13px;background:var(--foam);border:1px solid var(--steam);border-radius:9px;font-family:'DM Sans',sans-serif;font-size:13px;color:var(--espresso);outline:none}

/* MODAL */
.mo{position:fixed;inset:0;z-index:200;background:rgba(26,15,10,.6);backdrop-filter:blur(4px);display:none;align-items:center;justify-content:center}
.mo.open{display:flex;animation:fadeIn .2s ease}
.modal{background:var(--warm-white);border-radius:18px;width:90%;max-width:480px;max-height:90vh;overflow-y:auto;box-shadow:0 20px 60px rgba(26,15,10,.3)}
.mh{padding:18px 24px;border-bottom:1px solid var(--steam);display:flex;align-items:center;justify-content:space-between;background:var(--foam)}
.mt{font-family:'Playfair Display',serif;font-size:18px}
.mc{background:none;border:none;cursor:pointer;font-size:18px;color:var(--mocha);padding:3px 7px;border-radius:5px}
.mc:hover{background:var(--steam)}
.mb{padding:24px}

/* MISC */
.tv{font-family:'DM Mono',monospace;font-size:13px}
.wh{font-family:'DM Mono',monospace;font-size:13px;font-weight:500;color:var(--ivy)}
.vob{background:linear-gradient(135deg,rgba(61,107,74,.1),rgba(200,133,74,.08));border:1px solid rgba(61,107,74,.2);border-radius:10px;padding:11px 16px;display:flex;align-items:center;gap:9px;margin-bottom:16px;font-size:13px;color:var(--mocha)}

/* CALENDAR */
.cg{display:grid;grid-template-columns:repeat(7,1fr);gap:3px;margin-top:9px}
.cdl{font-size:10px;font-weight:600;text-transform:uppercase;color:var(--mocha);text-align:center;padding:3px}
.cd{aspect-ratio:1;border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:10px;font-family:'DM Mono',monospace}
.cdp{background:rgba(61,107,74,.18);color:var(--ivy)}
.cda{background:rgba(184,84,80,.14);color:var(--red)}
.cdw{background:rgba(212,160,23,.12);color:var(--amber)}
.cdl2{background:rgba(200,133,74,.18);color:var(--caramel)}
.cde{background:transparent}
.cdt{outline:2px solid var(--ivy);outline-offset:1px}

::-webkit-scrollbar{width:5px;height:5px}
::-webkit-scrollbar-track{background:var(--cream)}
::-webkit-scrollbar-thumb{background:var(--steam);border-radius:99px}

@media(max-width:768px){
  nav{padding:0 12px}.nav-badge{display:none}
  main{padding:12px}.g2{grid-template-columns:1fr}
  .clock{flex-direction:column;gap:14px}.ctime{font-size:34px}
  .sg{grid-template-columns:1fr 1fr}
}
</style>
</head>
<body>

<div id="loader"><div class="spin"></div><div class="load-txt" id="load-txt">Connecting...</div></div>

<div id="login-screen">
  <div class="login-box">
    <div class="login-icon">üçÉ</div>
    <div class="login-title">Trailing Ivy Caf√©</div>
    <div class="login-sub">Staff Attendance System</div>
    <div class="role-tabs">
      <div class="role-tab active" onclick="selRole('admin')" id="tab-admin">
        <span class="role-tab-icon">üîê</span>
        <div class="role-tab-name">Admin</div>
        <div class="role-tab-desc">Full access</div>
      </div>
      <div class="role-tab" onclick="selRole('user')" id="tab-user">
        <span class="role-tab-icon">üëÅÔ∏è</span>
        <div class="role-tab-name">Viewer</div>
        <div class="role-tab-desc">View only</div>
      </div>
    </div>
    <label class="lbl">Username</label>
    <input class="inp" type="text" id="lu" placeholder="Enter username" autocomplete="off">
    <label class="lbl">Password</label>
    <input class="inp" type="password" id="lp" placeholder="Enter password" onkeydown="if(event.key==='Enter')doLogin()">
    <button class="login-btn" onclick="doLogin()">Sign In ‚Üí</button>
    <div class="login-err" id="lerr">‚ùå Wrong username or password</div>
    <div class="login-hint"><strong>Admin:</strong> admin / admin123 &nbsp;|&nbsp; <strong>Viewer:</strong> viewer / view123</div>
  </div>
</div>

<div class="app" id="app" style="display:none">
<nav>
  <div class="nav-logo">üçÉ Trailing Ivy Caf√© <span class="nav-badge" id="rbadge">ADMIN</span></div>
  <div class="nav-tabs" id="ntabs"></div>
  <div class="nav-right">
    <div class="nav-user"><div class="avatar" id="navav">A</div><span id="navname">Admin</span></div>
    <button class="logout-btn" onclick="doLogout()">Sign Out</button>
  </div>
</nav>
<main>

<!-- ADMIN DASHBOARD -->
<div class="panel" id="panel-admin">
  <div class="ph"><div><div class="pt">Good Morning ‚òï</div><div class="ps">Admin Dashboard ‚Äî Full Access</div></div><div class="dbadge" id="hdate">‚Äî</div></div>
  <div class="ann"><div class="ann-icon">üçÉ</div><div class="ann-text"><strong>Announcement</strong>Welcome to Trailing Ivy Caf√© Attendance System!</div></div>
  <div class="sg">
    <div class="sc g"><div class="sl">Present Today</div><div class="sv" id="s1">‚Äî</div><div class="ss">of <span id="s1t">‚Äî</span> staff</div></div>
    <div class="sc r"><div class="sl">Absent</div><div class="sv" id="s2">‚Äî</div></div>
    <div class="sc a"><div class="sl">Week Off</div><div class="sv" id="s3">‚Äî</div></div>
    <div class="sc"><div class="sl">Late Today</div><div class="sv" id="s4">‚Äî</div></div>
    <div class="sc"><div class="sl">Avg Hours</div><div class="sv" id="s5">‚Äî</div></div>
  </div>
  <div class="g2">
    <div class="card"><div class="ch"><div class="ct">Today's Log</div><button class="btn btn-ivy btn-sm" onclick="openM('m-log')">+ Log Entry</button></div><div class="cb" id="tlog"></div></div>
    <div class="card"><div class="ch"><div class="ct">On Break</div><span class="badge bl">Live</span></div><div class="cb" id="blog"></div></div>
  </div>
  <div class="card">
    <div class="ch"><div class="ct">Attendance Register</div><button class="btn btn-o btn-sm" onclick="exportCSV()">‚¨á Export</button></div>
    <div class="cb"><div class="tw"><table><thead><tr><th>ID</th><th>Name</th><th>Role</th><th>Check-In</th><th>Break</th><th>Check-Out</th><th>Status</th><th>Hrs</th><th>Edit</th></tr></thead><tbody id="atbody"></tbody></table></div></div>
  </div>
</div>

<!-- CHECK-IN -->
<div class="panel" id="panel-checkin">
  <div class="ph"><div><div class="pt">Time Terminal</div><div class="ps">Log check-in, breaks & check-out</div></div><div class="dbadge" id="cidate">‚Äî</div></div>
  <div class="clock">
    <div><div class="ctime" id="clk">00:00:00</div><div class="cdate" id="clkd">Loading...</div></div>
    <div class="cactions">
      <select id="cisel" style="background:rgba(255,255,255,.1);border:1px solid rgba(245,239,228,.2);color:var(--cream);border-radius:9px;padding:7px 13px;font-size:13px;outline:none;min-width:170px;"></select>
      <div style="display:flex;gap:7px;flex-wrap:wrap;justify-content:flex-end">
        <button class="btn btn-sm btn-g" onclick="logA('ci')">‚úì Check-In</button>
        <button class="btn btn-sm btn-c" onclick="logA('bs')">‚è∏ Break</button>
        <button class="btn btn-sm btn-o" style="color:var(--cream);border-color:rgba(245,239,228,.3)" onclick="logA('be')">‚ñ∂ Resume</button>
        <button class="btn btn-sm btn-r" onclick="logA('co')">‚úó Check-Out</button>
      </div>
    </div>
  </div>
  <div class="card"><div class="ch"><div class="ct">Current Status</div></div><div class="cb"><div id="scards" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:9px"></div></div></div>
</div>

<!-- REPORTS -->
<div class="panel" id="panel-reports">
  <div class="ph"><div><div class="pt">Monthly Reports</div><div class="ps">Analytics & performance</div></div></div>
  <div class="fr">
    <select id="rm" onchange="renderRpt()"><option value="0">January</option><option value="1">February</option><option value="2">March</option><option value="3">April</option><option value="4">May</option><option value="5">June</option><option value="6">July</option><option value="7">August</option><option value="8">September</option><option value="9">October</option><option value="10">November</option><option value="11">December</option></select>
    <select id="ry" onchange="renderRpt()"><option>2025</option><option selected>2026</option></select>
    <button class="btn btn-o btn-sm" onclick="exportCSV()">‚¨á Export</button>
  </div>
  <div class="sg" id="rsStats"></div>
  <div class="g2">
    <div class="card"><div class="ch"><div class="ct">Attendance %</div></div><div class="cb" id="rchart"></div></div>
    <div class="card"><div class="ch"><div class="ct">Monthly Summary</div></div><div class="cb"><div class="tw"><table><thead><tr><th>Name</th><th>Present</th><th>Absent</th><th>Late</th><th>Avg Hrs</th></tr></thead><tbody id="rsum"></tbody></table></div></div></div>
  </div>
</div>

<!-- STAFF -->
<div class="panel" id="panel-staff">
  <div class="ph"><div><div class="pt">Staff Directory</div><div class="ps">Manage your team</div></div><button class="btn btn-p" onclick="openM('m-staff')">+ Add Staff</button></div>
  <div class="card"><div class="cb"><div class="tw"><table><thead><tr><th>ID</th><th>Name</th><th>Role</th><th>Shift Start</th><th>Shift End</th><th>Week Off</th><th>Action</th></tr></thead><tbody id="stbody"></tbody></table></div></div></div>
</div>

<!-- VIEWER -->
<div class="panel" id="panel-viewer">
  <div class="ph"><div><div class="pt">Staff Overview</div><div class="ps">Viewer Dashboard ‚Äî Read Only</div></div><div class="dbadge" id="vdate">‚Äî</div></div>
  <div class="vob">üëÅÔ∏è <strong style="margin-right:3px">View Only</strong> ‚Äî No changes allowed</div>
  <div class="ann"><div class="ann-icon">üì¢</div><div class="ann-text"><strong>Notice</strong>Welcome to Trailing Ivy Caf√© Staff Overview! üçÉ</div></div>
  <div class="sg" id="vstats"></div>
  <div class="fr">
    <select id="vm" onchange="renderViewer()"><option value="0">January</option><option value="1">February</option><option value="2">March</option><option value="3">April</option><option value="4">May</option><option value="5">June</option><option value="6">July</option><option value="7">August</option><option value="8">September</option><option value="9">October</option><option value="10">November</option><option value="11">December</option></select>
    <select id="vs" onchange="renderViewer()"><option value="all">All Staff</option></select>
  </div>
  <div id="vcards" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:14px"></div>
</div>

</main>
</div>

<!-- MODAL: LOG -->
<div class="mo" id="m-log">
  <div class="modal">
    <div class="mh"><div class="mt">Log Attendance</div><button class="mc" onclick="closeM('m-log')">‚úï</button></div>
    <div class="mb">
      <div class="fg"><label class="lbl2">Select Staff</label><select class="inp2" id="mls"><option value="">‚Äî Choose ‚Äî</option></select></div>
      <div class="g2">
        <div class="fg"><label class="lbl2">Date</label><input class="inp2" type="date" id="mld"></div>
        <div class="fg"><label class="lbl2">Action</label><select class="inp2" id="mla"><option>Check-In</option><option>Break Start</option><option>Break End</option><option>Check-Out</option></select></div>
      </div>
      <div class="fg"><label class="lbl2">Time (blank = now)</label><input class="inp2" type="time" id="mlt"></div>
      <button class="btn btn-ivy" style="width:100%;padding:11px" onclick="submitLog()">Submit</button>
    </div>
  </div>
</div>

<!-- MODAL: ADD STAFF -->
<div class="mo" id="m-staff">
  <div class="modal">
    <div class="mh"><div class="mt">Add New Staff</div><button class="mc" onclick="closeM('m-staff')">‚úï</button></div>
    <div class="mb">
      <div class="g2">
        <div class="fg"><label class="lbl2">Full Name</label><input class="inp2" type="text" id="sn" placeholder="Staff name"></div>
        <div class="fg"><label class="lbl2">Role</label><select class="inp2" id="sr"><option>Barista</option><option>Cashier</option><option>Supervisor</option><option>Chef</option><option>Cafe Helper</option><option>Cleaner</option><option>Manager</option></select></div>
      </div>
      <div class="g2">
        <div class="fg"><label class="lbl2">Shift Start</label><input class="inp2" type="time" id="ss" value="09:00"></div>
        <div class="fg"><label class="lbl2">Shift End</label><input class="inp2" type="time" id="se" value="18:00"></div>
      </div>
      <div class="fg"><label class="lbl2">Week Off</label><select class="inp2" id="sw"><option>Monday</option><option>Tuesday</option><option>Wednesday</option><option>Thursday</option><option>Friday</option><option selected>Saturday</option><option>Sunday</option></select></div>
      <button class="btn btn-ivy" style="width:100%;padding:11px" onclick="addStaff()">Add Staff Member</button>
    </div>
  </div>
</div>

<!-- MODAL: EDIT -->
<div class="mo" id="m-edit">
  <div class="modal">
    <div class="mh"><div class="mt">Edit Record</div><button class="mc" onclick="closeM('m-edit')">‚úï</button></div>
    <div class="mb" id="editbody"></div>
  </div>
</div>

<script>
// ‚ïê‚ïê SUPABASE INIT ‚ïê‚ïê
const SB_URL = 'https://mmhjmgdyoejnktumhflz.supabase.co';
const SB_KEY = 'sb_publishable_wEoorrH4w8NHPZexsJvYWg_OZCrpi7r';

let SB;
function initSB() {
  try {
    if (window.supabase) {
      SB = window.supabase.createClient(SB_URL, SB_KEY);
      console.log('‚úÖ Supabase connected!');
    } else {
      console.error('‚ùå Supabase library not loaded');
      alert('Database connection failed. Please check your internet and refresh.');
    }
  } catch(e) {
    console.error('Supabase init error:', e);
    alert('Error: ' + e.message);
  }
}
initSB();

// ‚ïê‚ïê STATE ‚ïê‚ïê
let staffList = [];
let attList = [];
let role = null;
let selRole = 'admin';
const today = new Date();
const todayStr = fmtDate(today);

// ‚ïê‚ïê HELPERS ‚ïê‚ïê
function fmtDate(d){return d.toISOString().split('T')[0];}
function t2m(t){if(!t)return 0;const[h,m]=t.split(':');return +h*60+ +m;}
function nowT(){const n=new Date();return `${String(n.getHours()).padStart(2,'0')}:${String(n.getMinutes()).padStart(2,'0')}`;}
function wkHrs(r){
  if(!r||!r.check_in||!r.check_out)return '‚Äî';
  let t=t2m(r.check_out)-t2m(r.check_in);
  if(r.break_start&&r.break_end)t-=t2m(r.break_end)-t2m(r.break_start);
  if(t<=0)return '‚Äî';
  return `${Math.floor(t/60)}h ${String(t%60).padStart(2,'0')}m`;
}
function wkMin(r){
  if(!r||!r.check_in||!r.check_out)return 0;
  let t=t2m(r.check_out)-t2m(r.check_in);
  if(r.break_start&&r.break_end)t-=t2m(r.break_end)-t2m(r.break_start);
  return Math.max(0,t);
}
function getS(id){return staffList.find(s=>s.id===id)||{};}
function getTR(id){return attList.find(a=>a.date===todayStr&&a.staff_id===id);}
function openM(id){document.getElementById(id).classList.add('open');}
function closeM(id){document.getElementById(id).classList.remove('open');}
function load(txt='Saving...'){document.getElementById('load-txt').textContent=txt;document.getElementById('loader').classList.add('on');}
function unload(){document.getElementById('loader').classList.remove('on');}
function sbadge(s){
  const cls={Present:'bp',Absent:'ba','Week Off':'bw',Late:'bl'};
  const dot={Present:'üü¢',Absent:'üî¥','Week Off':'üü°',Late:'üü†'};
  return `<span class="badge ${cls[s]||'br'}">${dot[s]||'‚ö™'} ${s||'‚Äî'}</span>`;
}

// ‚ïê‚ïê CLOCK ‚ïê‚ïê
function tick(){
  const n=new Date();
  const ts=n.toLocaleTimeString('en-IN',{hour12:false});
  const ds=n.toLocaleDateString('en-IN',{weekday:'long',year:'numeric',month:'long',day:'numeric'});
  const sd=n.toLocaleDateString('en-IN',{day:'2-digit',month:'short',year:'numeric'});
  const ce=document.getElementById('clk');if(ce)ce.textContent=ts;
  const de=document.getElementById('clkd');if(de)de.textContent=ds;
  ['hdate','cidate','vdate'].forEach(id=>{const el=document.getElementById(id);if(el)el.textContent=sd;});
}
setInterval(tick,1000);tick();

// ‚ïê‚ïê AUTH ‚ïê‚ïê
const CREDS={admin:{pass:'admin123',role:'admin'},viewer:{pass:'view123',role:'user'}};

function selRole(r){
  selRole=r;
  document.getElementById('tab-admin').classList.toggle('active',r==='admin');
  document.getElementById('tab-user').classList.toggle('active',r==='user');
  document.getElementById('lerr').style.display='none';
}
// fix naming conflict
window.selRole = selRole;

async function doLogin(){
  const u=document.getElementById('lu').value.trim().toLowerCase();
  const p=document.getElementById('lp').value;
  const err=document.getElementById('lerr');
  const cred=CREDS[u];
  if(!cred||cred.pass!==p||cred.role!==selRole){err.style.display='block';return;}
  err.style.display='none';
  role=cred.role;
  load('Loading data...');
  await fetchAll();
  unload();
  document.getElementById('login-screen').style.display='none';
  document.getElementById('app').style.display='flex';
  setupApp();
}

function doLogout(){
  role=null;
  document.getElementById('login-screen').style.display='flex';
  document.getElementById('app').style.display='none';
  document.getElementById('lu').value='';
  document.getElementById('lp').value='';
  document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
}

// ‚ïê‚ïê DATA ‚ïê‚ïê
async function fetchAll(){
  try {
    const [sr,ar]=await Promise.all([SB.from('staff').select('*'),SB.from('attendance').select('*')]);
    if(sr.data)staffList=sr.data;
    if(ar.data)attList=ar.data;
    if(sr.error)console.error('Staff error:',sr.error);
    if(ar.error)console.error('Att error:',ar.error);
  } catch(e){ console.error('Fetch error:',e); }
}

async function fetchAtt(){
  try {
    const {data,error}=await SB.from('attendance').select('*');
    if(data)attList=data;
    if(error)console.error(error);
  } catch(e){ console.error(e); }
}

// ‚ïê‚ïê SETUP ‚ïê‚ïê
function setupApp(){
  const isAdmin=role==='admin';
  document.getElementById('rbadge').textContent=isAdmin?'ADMIN':'VIEWER';
  document.getElementById('navav').textContent=isAdmin?'A':'V';
  document.getElementById('navname').textContent=isAdmin?'Admin':'Viewer';
  const nt=document.getElementById('ntabs');
  if(isAdmin){
    nt.innerHTML=`
      <button class="nav-tab active" onclick="showP('admin',this)">Dashboard</button>
      <button class="nav-tab" onclick="showP('checkin',this)">Check-In</button>
      <button class="nav-tab" onclick="showP('reports',this)">Reports</button>
      <button class="nav-tab" onclick="showP('staff',this)">Staff</button>`;
    showP('admin',nt.firstElementChild);
  }else{
    nt.innerHTML=`<button class="nav-tab active" onclick="showP('viewer',this)">Overview</button>`;
    showP('viewer',nt.firstElementChild);
  }
  fillSelects();
  setMF();
  document.getElementById('mld').value=todayStr;
}

function showP(name,btn){
  document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.nav-tab').forEach(t=>t.classList.remove('active'));
  const p=document.getElementById('panel-'+name);
  if(p)p.classList.add('active');
  if(btn)btn.classList.add('active');
  if(name==='admin')renderAdmin();
  if(name==='checkin')renderCI();
  if(name==='reports')renderRpt();
  if(name==='staff')renderStaff();
  if(name==='viewer')renderViewer();
}

function fillSelects(){
  const opts=staffList.map(s=>`<option value="${s.id}">${s.name} (${s.id})</option>`).join('');
  ['mls','cisel'].forEach(id=>{const el=document.getElementById(id);if(el){const cur=el.value;el.innerHTML='<option value="">‚Äî Select ‚Äî</option>'+opts;if(cur)el.value=cur;}});
  const vs=document.getElementById('vs');
  if(vs)vs.innerHTML='<option value="all">All Staff</option>'+staffList.map(s=>`<option value="${s.id}">${s.name}</option>`).join('');
}

function setMF(){
  const m=new Date().getMonth();
  ['rm','vm'].forEach(id=>{const el=document.getElementById(id);if(el)el.value=m;});
}

// ‚ïê‚ïê ADMIN ‚ïê‚ïê
function renderAdmin(){
  const recs=attList.filter(a=>a.date===todayStr);
  let p=0,ab=0,wo=0,lt=0,th=0,hc=0;
  staffList.forEach(s=>{
    const r=recs.find(x=>x.staff_id===s.id);
    if(!r||r.status==='Absent')ab++;
    else if(r.status==='Week Off')wo++;
    else{p++;if(r.status==='Late')lt++;}
    const w=r?wkMin(r):0;
    if(w>0){th+=w;hc++;}
  });
  document.getElementById('s1').textContent=p;
  document.getElementById('s2').textContent=ab;
  document.getElementById('s3').textContent=wo;
  document.getElementById('s4').textContent=lt;
  document.getElementById('s1t').textContent=staffList.length;
  document.getElementById('s5').textContent=hc?Math.floor(th/hc/60)+'h '+Math.floor(th/hc)%60+'m':'‚Äî';

  document.getElementById('tlog').innerHTML=recs.filter(r=>r.check_in).map(r=>{
    const s=getS(r.staff_id);
    return `<div class="le"><div class="ld ${r.status==='Late'?'lda':'ldg'}"></div><div class="li"><div class="ln">${s.name||'Unknown'}</div><div class="ldt">${s.role||''} ¬∑ ${r.status}</div></div><div class="lt">${r.check_in}</div></div>`;
  }).join('')||'<div style="color:var(--mocha);font-size:13px">No check-ins yet.</div>';

  const ob=recs.filter(r=>r.break_start&&!r.break_end&&!r.check_out);
  document.getElementById('blog').innerHTML=ob.length?ob.map(r=>{
    const s=getS(r.staff_id);
    return `<div class="le"><div class="ld lda"></div><div class="li"><div class="ln">${s.name||'Unknown'}</div><div class="ldt">Since ${r.break_start}</div></div><div class="lt">‚è∏</div></div>`;
  }).join(''):'<div style="color:var(--mocha);font-size:13px">No one on break.</div>';

  document.getElementById('atbody').innerHTML=staffList.map(s=>{
    const r=recs.find(x=>x.staff_id===s.id)||{};
    return `<tr><td class="tv">${s.id}</td><td><strong>${s.name}</strong></td><td style="color:var(--mocha)">${s.role}</td><td class="tv">${r.check_in||'‚Äî'}</td><td class="tv">${r.break_start?(r.break_end?r.break_start+' ‚Äì '+r.break_end:r.break_start+' ‚è∏'):'-'}</td><td class="tv">${r.check_out||'‚Äî'}</td><td>${sbadge(r.status||'Absent')}</td><td><span class="wh">${wkHrs(r)}</span></td><td><button class="btn btn-o btn-sm" onclick="editRec('${s.id}')">Edit</button></td></tr>`;
  }).join('');
  fillSelects();
}

// ‚ïê‚ïê CHECK-IN ‚ïê‚ïê
function renderCI(){
  fillSelects();
  document.getElementById('scards').innerHTML=staffList.map(s=>{
    const r=getTR(s.id)||{};
    let txt='Not Checked In',bg='rgba(107,63,42,.06)',tc='var(--mocha)';
    if(r.check_in&&!r.check_out){txt='Working';bg='rgba(61,107,74,.12)';tc='var(--ivy)';}
    if(r.break_start&&!r.break_end){txt='On Break';bg='rgba(212,160,23,.1)';tc='var(--amber)';}
    if(r.check_out){txt='Checked Out';bg='rgba(107,63,42,.06)';tc='var(--mocha)';}
    if(r.status==='Week Off'){txt='Week Off';bg='rgba(212,160,23,.08)';tc='var(--amber)';}
    return `<div style="background:${bg};border:1px solid var(--steam);border-radius:11px;padding:13px"><div style="font-size:13px;font-weight:600">${s.name}</div><div style="font-size:11px;color:var(--mocha);margin-bottom:5px">${s.role}</div><div style="font-size:12px;font-weight:600;color:${tc}">${txt}</div>${r.check_in?`<div class="tv" style="font-size:11px;color:var(--mocha);margin-top:2px">In: ${r.check_in}${r.check_out?' | Out: '+r.check_out:''}</div>`:''}</div>`;
  }).join('');
}

async function logA(action){
  const sid=document.getElementById('cisel').value;
  if(!sid){alert('Please select a staff member first.');return;}
  const now=nowT();
  const s=getS(sid);
  let rec=attList.find(a=>a.date===todayStr&&a.staff_id===sid);
  load('Saving...');
  try {
    if(!rec){
      const{data,error}=await SB.from('attendance').insert([{date:todayStr,staff_id:sid,check_in:'',break_start:'',break_end:'',check_out:'',status:'Present',notes:''}]).select();
      if(error){console.error(error);unload();alert('Error: '+error.message);return;}
      if(data){rec=data[0];attList.push(rec);}
    }
    const upd={};
    if(action==='ci'){
      if(rec.check_in){unload();alert('Already checked in at '+rec.check_in);return;}
      upd.check_in=now;upd.status=t2m(now)>t2m(s.shift_start)+15?'Late':'Present';
    }else if(action==='bs'){
      if(!rec.check_in){unload();alert('Not checked in yet.');return;}
      upd.break_start=now;upd.break_end='';
    }else if(action==='be'){
      if(!rec.break_start){unload();alert('No active break.');return;}
      upd.break_end=now;
    }else if(action==='co'){
      if(!rec.check_in){unload();alert('Not checked in yet.');return;}
      upd.check_out=now;
    }
    const{error}=await SB.from('attendance').update(upd).eq('date',todayStr).eq('staff_id',sid);
    if(error){console.error(error);unload();alert('Save error: '+error.message);return;}
    await fetchAtt();
  } catch(e){ console.error(e);alert('Error: '+e.message); }
  unload();renderCI();renderAdmin();
}

async function submitLog(){
  const sid=document.getElementById('mls').value;
  const date=document.getElementById('mld').value;
  const action=document.getElementById('mla').value;
  const time=document.getElementById('mlt').value||nowT();
  if(!sid||!date){alert('Please fill all fields.');return;}
  load('Saving...');
  try {
    let rec=attList.find(a=>a.date===date&&a.staff_id===sid);
    if(!rec){
      const{data,error}=await SB.from('attendance').insert([{date,staff_id:sid,check_in:'',break_start:'',break_end:'',check_out:'',status:'Present',notes:''}]).select();
      if(error){unload();alert('Error: '+error.message);return;}
      if(data){rec=data[0];attList.push(rec);}
    }
    const upd={};const s=getS(sid);
    if(action==='Check-In'){upd.check_in=time;upd.status=t2m(time)>t2m(s.shift_start)+15?'Late':'Present';}
    else if(action==='Break Start')upd.break_start=time;
    else if(action==='Break End')upd.break_end=time;
    else if(action==='Check-Out')upd.check_out=time;
    const{error}=await SB.from('attendance').update(upd).eq('date',date).eq('staff_id',sid);
    if(error){unload();alert('Error: '+error.message);return;}
    await fetchAtt();
  } catch(e){ console.error(e);alert('Error: '+e.message); }
  unload();closeM('m-log');renderAdmin();
}

function editRec(sid){
  const rec=attList.find(a=>a.date===todayStr&&a.staff_id===sid)||{check_in:'',check_out:'',break_start:'',break_end:'',status:'Present'};
  const s=getS(sid);
  document.getElementById('editbody').innerHTML=`
    <p style="font-size:14px;font-weight:600;margin-bottom:14px">${s.name} ‚Äî ${todayStr}</p>
    <div class="g2">
      <div class="fg"><label class="lbl2">Check-In</label><input class="inp2" type="time" id="eci" value="${rec.check_in||''}"></div>
      <div class="fg"><label class="lbl2">Check-Out</label><input class="inp2" type="time" id="eco" value="${rec.check_out||''}"></div>
      <div class="fg"><label class="lbl2">Break Start</label><input class="inp2" type="time" id="ebs" value="${rec.break_start||''}"></div>
      <div class="fg"><label class="lbl2">Break End</label><input class="inp2" type="time" id="ebe" value="${rec.break_end||''}"></div>
    </div>
    <div class="fg"><label class="lbl2">Status</label><select class="inp2" id="est">${['Present','Absent','Late','Week Off'].map(v=>`<option ${rec.status===v?'selected':''}>${v}</option>`).join('')}</select></div>
    <button class="btn btn-ivy" style="width:100%;padding:11px" onclick="saveEdit('${sid}')">Save Changes</button>`;
  openM('m-edit');
}

async function saveEdit(sid){
  const upd={check_in:document.getElementById('eci').value,check_out:document.getElementById('eco').value,break_start:document.getElementById('ebs').value,break_end:document.getElementById('ebe').value,status:document.getElementById('est').value};
  load('Saving...');
  try {
    const ex=attList.find(a=>a.date===todayStr&&a.staff_id===sid);
    if(ex){await SB.from('attendance').update(upd).eq('date',todayStr).eq('staff_id',sid);}
    else{await SB.from('attendance').insert([{date:todayStr,staff_id:sid,...upd,notes:''}]);}
    await fetchAtt();
  } catch(e){ console.error(e); }
  unload();closeM('m-edit');renderAdmin();
}

// ‚ïê‚ïê REPORTS ‚ïê‚ïê
function renderRpt(){
  const mo=+document.getElementById('rm').value;
  const yr=+document.getElementById('ry').value;
  const dim=new Date(yr,mo+1,0).getDate();
  const recs=attList.filter(a=>{const d=new Date(a.date);return d.getMonth()===mo&&d.getFullYear()===yr;});
  let tp=0,ta=0,tl=0;
  const rows=staffList.map(s=>{
    const sr=recs.filter(r=>r.staff_id===s.id);
    const pres=sr.filter(r=>r.status==='Present'||r.status==='Late').length;
    const abs=sr.filter(r=>r.status==='Absent').length;
    const late=sr.filter(r=>r.status==='Late').length;
    const hrs=sr.reduce((a,r)=>a+wkMin(r),0);
    const avg=pres?Math.floor(hrs/pres/60)+'h '+Math.floor(hrs/pres)%60+'m':'‚Äî';
    tp+=pres;ta+=abs;tl+=late;
    return{s,pres,abs,late,avg,pct:Math.round(pres/Math.max(dim,1)*100)};
  });
  document.getElementById('rsStats').innerHTML=`
    <div class="sc g"><div class="sl">Total Present</div><div class="sv">${tp}</div></div>
    <div class="sc r"><div class="sl">Total Absent</div><div class="sv">${ta}</div></div>
    <div class="sc a"><div class="sl">Late Arrivals</div><div class="sv">${tl}</div></div>
    <div class="sc"><div class="sl">Avg Attendance</div><div class="sv">${Math.round(tp/(staffList.length*dim||1)*100)}%</div></div>`;
  document.getElementById('rchart').innerHTML=rows.map(({s,pct})=>`<div class="pr"><div class="pn">${s.name.split(' ')[0]}</div><div style="flex:1"><div class="pb"><div class="pf" style="width:${pct}%"></div></div></div><div class="pp">${pct}%</div></div>`).join('');
  document.getElementById('rsum').innerHTML=rows.map(({s,pres,abs,late,avg})=>`<tr><td><strong>${s.name}</strong></td><td>${pres}</td><td>${abs}</td><td>${late?`<span style="color:var(--caramel)">${late}</span>`:'0'}</td><td class="tv">${avg}</td></tr>`).join('');
}

// ‚ïê‚ïê VIEWER ‚ïê‚ïê
function renderViewer(){
  fillSelects();
  const mo=+document.getElementById('vm').value;
  const yr=new Date().getFullYear();
  const flt=document.getElementById('vs').value;
  const dim=new Date(yr,mo+1,0).getDate();
  const fl=flt==='all'?staffList:staffList.filter(s=>s.id===flt);
  const ar=attList.filter(a=>{const d=new Date(a.date);return d.getMonth()===mo&&d.getFullYear()===yr;});
  let tp=0,ta=0,tw=0;
  fl.forEach(s=>{
    const sr=ar.filter(r=>r.staff_id===s.id);
    tp+=sr.filter(r=>r.status==='Present'||r.status==='Late').length;
    ta+=sr.filter(r=>r.status==='Absent').length;
    tw+=sr.filter(r=>r.status==='Week Off').length;
  });
  document.getElementById('vstats').innerHTML=`
    <div class="sc g"><div class="sl">Present Days</div><div class="sv">${tp}</div></div>
    <div class="sc r"><div class="sl">Absent Days</div><div class="sv">${ta}</div></div>
    <div class="sc a"><div class="sl">Week Offs</div><div class="sv">${tw}</div></div>
    <div class="sc"><div class="sl">Staff Shown</div><div class="sv">${fl.length}</div></div>`;
  document.getElementById('vcards').innerHTML=fl.map(s=>{
    const recs=ar.filter(r=>r.staff_id===s.id);
    const pres=recs.filter(r=>r.status==='Present'||r.status==='Late').length;
    const abs=recs.filter(r=>r.status==='Absent').length;
    const wo=recs.filter(r=>r.status==='Week Off').length;
    const hrs=recs.reduce((a,r)=>a+wkMin(r),0);
    const avgH=pres?Math.floor(hrs/pres/60)+'h '+Math.floor(hrs/pres)%60+'m':'‚Äî';
    const pct=Math.round(pres/Math.max(dim-wo,1)*100);
    const fd=new Date(yr,mo,1).getDay();
    const days=['S','M','T','W','T','F','S'];
    let cal=days.map(d=>`<div class="cdl">${d}</div>`).join('');
    for(let i=0;i<fd;i++)cal+=`<div class="cde"></div>`;
    for(let d=1;d<=dim;d++){
      const ds=`${yr}-${String(mo+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
      const r=recs.find(x=>x.date===ds);
      const it=ds===todayStr;
      let cls='cde';
      if(r){if(r.status==='Present')cls='cdp';else if(r.status==='Late')cls='cdl2';else if(r.status==='Absent')cls='cda';else if(r.status==='Week Off')cls='cdw';}
      cal+=`<div class="cd ${cls}${it?' cdt':''}">${d}</div>`;
    }
    return `<div class="card">
      <div class="ch" style="flex-direction:column;align-items:flex-start;gap:5px">
        <div style="display:flex;align-items:center;justify-content:space-between;width:100%">
          <div><div class="ct">${s.name}</div><div style="font-size:12px;color:var(--mocha)">${s.role} ¬∑ ${s.id}</div></div>
          <div style="text-align:right"><div style="font-family:'DM Mono',monospace;font-size:22px;color:var(--ivy);font-weight:600">${pct}%</div><div style="font-size:11px;color:var(--mocha)">Attendance</div></div>
        </div>
        <div style="width:100%"><div class="pb"><div class="pf" style="width:${pct}%"></div></div></div>
      </div>
      <div class="cb">
        <div style="display:flex;gap:8px;margin-bottom:12px">
          <div style="flex:1;text-align:center;padding:9px;background:rgba(61,107,74,.08);border-radius:9px"><div style="font-family:'Playfair Display',serif;font-size:19px;color:var(--ivy)">${pres}</div><div style="font-size:11px;color:var(--mocha)">Present</div></div>
          <div style="flex:1;text-align:center;padding:9px;background:rgba(184,84,80,.08);border-radius:9px"><div style="font-family:'Playfair Display',serif;font-size:19px;color:var(--red)">${abs}</div><div style="font-size:11px;color:var(--mocha)">Absent</div></div>
          <div style="flex:1;text-align:center;padding:9px;background:rgba(212,160,23,.08);border-radius:9px"><div style="font-family:'Playfair Display',serif;font-size:19px;color:var(--amber)">${wo}</div><div style="font-size:11px;color:var(--mocha)">Off</div></div>
        </div>
        <div style="font-size:12px;color:var(--mocha);margin-bottom:8px">Avg Hrs: <strong>${avgH}</strong></div>
        <div class="cg">${cal}</div>
      </div>
    </div>`;
  }).join('');
}

// ‚ïê‚ïê STAFF ‚ïê‚ïê
function renderStaff(){
  document.getElementById('stbody').innerHTML=staffList.map(s=>`
    <tr><td class="tv">${s.id}</td><td><strong>${s.name}</strong></td><td><span class="badge br">${s.role}</span></td><td class="tv">${s.shift_start}</td><td class="tv">${s.shift_end}</td><td>${s.week_off}</td>
    <td><button class="btn btn-o btn-sm" style="color:var(--red);border-color:rgba(184,84,80,.3)" onclick="removeStaff('${s.id}')">Remove</button></td></tr>`).join('');
}

async function addStaff(){
  const name=document.getElementById('sn').value.trim();
  if(!name){alert('Please enter a name.');return;}
  const id='TI'+String(staffList.length+1).padStart(3,'0');
  const ns={id,name,role:document.getElementById('sr').value,shift_start:document.getElementById('ss').value,shift_end:document.getElementById('se').value,week_off:document.getElementById('sw').value};
  load('Adding...');
  try {
    const{error}=await SB.from('staff').insert([ns]);
    if(error){unload();alert('Error: '+error.message);return;}
    staffList.push(ns);
  } catch(e){ console.error(e); }
  document.getElementById('sn').value='';
  unload();closeM('m-staff');renderStaff();renderAdmin();fillSelects();
}

async function removeStaff(id){
  if(!confirm('Remove this staff member?'))return;
  load('Removing...');
  try {
    await SB.from('staff').delete().eq('id',id);
    staffList=staffList.filter(s=>s.id!==id);
  } catch(e){ console.error(e); }
  unload();renderStaff();renderAdmin();
}

// ‚ïê‚ïê EXPORT ‚ïê‚ïê
function exportCSV(){
  const h=['Date','Staff ID','Name','Role','Check-In','Break Start','Break End','Check-Out','Status','Working Hrs'];
  const rows=attList.map(r=>{const s=getS(r.staff_id);return[r.date,r.staff_id,s.name,s.role,r.check_in,r.break_start,r.break_end,r.check_out,r.status,wkHrs(r)];});
  const csv=[h,...rows].map(r=>r.join(',')).join('\n');
  const a=document.createElement('a');a.href='data:text/csv;charset=utf-8,'+encodeURIComponent(csv);
  a.download=`trailing-ivy-${todayStr}.csv`;a.click();
}

// ‚ïê‚ïê MODAL CLOSE ON BG ‚ïê‚ïê
document.querySelectorAll('.mo').forEach(el=>{
  el.addEventListener('click',e=>{if(e.target===el)el.classList.remove('open');});
});
</script>
</body>
</html>
