<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Trailing Ivy Caf√© ‚Äî Staff Attendance</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,600;0,700;1,400&family=DM+Sans:wght@300;400;500&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
:root {
  --cream: #F5EFE4; --warm-white: #FAF7F2; --espresso: #2C1810;
  --dark-roast: #1A0F0A; --caramel: #C8854A; --latte: #D4A574;
  --mocha: #6B3F2A; --steam: #E8DDD0; --foam: #F0EAE0;
  --ivy: #3D6B4A; --ivy-light: #5A8F69;
  --accent-red: #B85450; --accent-amber: #D4A017;
  --shadow: rgba(44,24,16,0.12); --shadow-deep: rgba(44,24,16,0.22);
}
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: 'DM Sans', sans-serif; background: var(--cream); color: var(--espresso); min-height: 100vh; overflow-x: hidden; }
body::before {
  content: ''; position: fixed; inset: 0; z-index: 0;
  background-image: radial-gradient(ellipse at 20% 10%, rgba(61,107,74,0.07) 0%, transparent 50%), radial-gradient(ellipse at 80% 80%, rgba(200,133,74,0.06) 0%, transparent 50%);
  pointer-events: none;
}
#login-screen {
  position: fixed; inset: 0; z-index: 999;
  display: flex; align-items: center; justify-content: center;
  background: linear-gradient(145deg, var(--dark-roast) 0%, #2C1810 50%, #1E3A28 100%);
}
.login-box { background: var(--warm-white); border-radius: 24px; padding: 48px 44px; width: 92%; max-width: 420px; box-shadow: 0 32px 80px rgba(0,0,0,0.4); animation: loginPop 0.4s cubic-bezier(0.34,1.56,0.64,1); }
@keyframes loginPop { from { opacity:0; transform:scale(0.9) translateY(20px); } to { opacity:1; transform:none; } }
.login-logo { text-align: center; margin-bottom: 32px; }
.login-logo-icon { width: 64px; height: 64px; border-radius: 20px; background: linear-gradient(135deg, var(--ivy), var(--espresso)); display: flex; align-items: center; justify-content: center; font-size: 28px; margin: 0 auto 14px; box-shadow: 0 8px 24px rgba(61,107,74,0.3); }
.login-cafe-name { font-family: 'Playfair Display', serif; font-size: 26px; font-weight: 700; }
.login-cafe-sub { font-size: 13px; color: var(--mocha); margin-top: 4px; font-style: italic; }
.role-tabs { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 24px; }
.role-tab { padding: 12px; border-radius: 12px; border: 2px solid var(--steam); background: var(--foam); cursor: pointer; text-align: center; transition: all 0.2s; font-family: 'DM Sans', sans-serif; }
.role-tab:hover { border-color: var(--latte); }
.role-tab.active { border-color: var(--ivy); background: rgba(61,107,74,0.08); }
.role-tab-icon { font-size: 22px; display: block; margin-bottom: 4px; }
.role-tab-name { font-size: 13px; font-weight: 600; }
.role-tab-desc { font-size: 11px; color: var(--mocha); }
.login-form .form-group { margin-bottom: 16px; }
.login-form label { display: block; font-size: 11px; font-weight: 600; letter-spacing: 0.6px; text-transform: uppercase; color: var(--mocha); margin-bottom: 6px; }
.login-form input { width: 100%; background: var(--foam); border: 1.5px solid var(--steam); border-radius: 12px; padding: 12px 16px; font-family: 'DM Sans', sans-serif; font-size: 15px; color: var(--espresso); outline: none; transition: border 0.2s; }
.login-form input:focus { border-color: var(--ivy); box-shadow: 0 0 0 3px rgba(61,107,74,0.1); }
.login-btn { width: 100%; padding: 14px; border: none; border-radius: 12px; background: linear-gradient(135deg, var(--ivy), #2D5438); color: white; font-family: 'DM Sans', sans-serif; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.2s; margin-top: 8px; }
.login-btn:hover { transform: translateY(-1px); box-shadow: 0 6px 20px rgba(61,107,74,0.35); }
.login-error { background: rgba(184,84,80,0.1); color: var(--accent-red); border: 1px solid rgba(184,84,80,0.2); border-radius: 10px; padding: 10px 14px; font-size: 13px; margin-top: 12px; display: none; }
.login-hint { font-size: 12px; color: var(--mocha); text-align: center; margin-top: 16px; line-height: 1.6; }
#loading-overlay { position: fixed; inset: 0; z-index: 500; background: rgba(245,239,228,0.92); backdrop-filter: blur(4px); display: none; align-items: center; justify-content: center; flex-direction: column; gap: 14px; }
#loading-overlay.show { display: flex; }
.spinner { width: 40px; height: 40px; border: 3px solid var(--steam); border-top-color: var(--ivy); border-radius: 50%; animation: spin 0.8s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }
.loading-text { font-size: 14px; color: var(--mocha); }
.app { position: relative; z-index: 1; display: flex; flex-direction: column; min-height: 100vh; }
nav { background: var(--espresso); display: flex; align-items: center; justify-content: space-between; padding: 0 28px; height: 64px; box-shadow: 0 4px 24px var(--shadow-deep); position: sticky; top: 0; z-index: 100; }
.logo { font-family: 'Playfair Display', serif; font-size: 20px; color: var(--latte); display: flex; align-items: center; gap: 10px; }
.logo-badge { background: linear-gradient(135deg, var(--ivy), #2D5438); padding: 5px 10px; border-radius: 8px; font-size: 11px; color: rgba(255,255,255,0.85); font-family: 'DM Sans', sans-serif; font-weight: 500; letter-spacing: 0.5px; margin-left: 6px; }
.nav-tabs { display: flex; gap: 4px; }
.nav-tab { background: none; border: none; cursor: pointer; color: rgba(245,239,228,0.55); font-family: 'DM Sans', sans-serif; font-size: 13px; font-weight: 500; padding: 8px 16px; border-radius: 8px; transition: all 0.2s; }
.nav-tab:hover { color: var(--latte); background: rgba(200,133,74,0.1); }
.nav-tab.active { color: var(--cream); background: rgba(200,133,74,0.18); }
.nav-right { display: flex; align-items: center; gap: 10px; }
.nav-user { color: var(--steam); font-size: 13px; display: flex; align-items: center; gap: 8px; }
.user-avatar { width: 34px; height: 34px; border-radius: 50%; background: linear-gradient(135deg, var(--ivy), var(--espresso)); display: flex; align-items: center; justify-content: center; color: var(--cream); font-size: 12px; font-weight: 700; border: 2px solid rgba(61,107,74,0.5); }
.logout-btn { background: rgba(184,84,80,0.15); border: 1px solid rgba(184,84,80,0.25); color: #D47470; padding: 6px 12px; border-radius: 8px; font-size: 12px; cursor: pointer; font-family: 'DM Sans', sans-serif; transition: all 0.2s; }
.logout-btn:hover { background: rgba(184,84,80,0.25); }
main { flex: 1; padding: 28px 32px; max-width: 1400px; margin: 0 auto; width: 100%; }
.panel { display: none; }
.panel.active { display: block; animation: fadeIn 0.3s ease; }
@keyframes fadeIn { from { opacity:0; transform:translateY(6px); } to { opacity:1; transform:none; } }
.page-header { display: flex; align-items: flex-end; justify-content: space-between; margin-bottom: 24px; }
.page-title { font-family: 'Playfair Display', serif; font-size: 28px; font-weight: 700; }
.page-subtitle { font-size: 13px; color: var(--mocha); margin-top: 2px; }
.date-badge { background: var(--espresso); color: var(--latte); padding: 8px 16px; border-radius: 24px; font-family: 'DM Mono', monospace; font-size: 13px; }
.stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(170px, 1fr)); gap: 14px; margin-bottom: 24px; }
.stat-card { background: var(--warm-white); border: 1px solid var(--steam); border-radius: 16px; padding: 18px 20px; position: relative; overflow: hidden; box-shadow: 0 2px 12px var(--shadow); transition: transform 0.2s; }
.stat-card:hover { transform: translateY(-2px); }
.stat-card::after { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px; background: linear-gradient(90deg, var(--caramel), var(--latte)); }
.stat-card.green::after { background: linear-gradient(90deg, var(--ivy), var(--ivy-light)); }
.stat-card.red::after { background: linear-gradient(90deg, var(--accent-red), #D47470); }
.stat-card.amber::after { background: linear-gradient(90deg, var(--accent-amber), #E8C44A); }
.stat-label { font-size: 11px; font-weight: 600; letter-spacing: 0.8px; text-transform: uppercase; color: var(--mocha); margin-bottom: 8px; }
.stat-value { font-family: 'Playfair Display', serif; font-size: 30px; line-height: 1; }
.stat-sub { font-size: 12px; color: var(--mocha); margin-top: 4px; }
.card { background: var(--warm-white); border: 1px solid var(--steam); border-radius: 16px; box-shadow: 0 2px 16px var(--shadow); overflow: hidden; margin-bottom: 20px; }
.card-header { padding: 16px 22px; border-bottom: 1px solid var(--steam); display: flex; align-items: center; justify-content: space-between; background: var(--foam); }
.card-title { font-family: 'Playfair Display', serif; font-size: 17px; font-weight: 600; }
.card-body { padding: 22px; }
.table-wrap { overflow-x: auto; }
table { width: 100%; border-collapse: collapse; }
thead th { font-size: 11px; font-weight: 600; letter-spacing: 0.8px; text-transform: uppercase; color: var(--mocha); padding: 10px 14px; text-align: left; background: var(--foam); border-bottom: 1px solid var(--steam); }
tbody td { padding: 11px 14px; font-size: 14px; border-bottom: 1px solid rgba(232,221,208,0.5); }
tbody tr:last-child td { border-bottom: none; }
tbody tr:hover { background: var(--foam); }
.badge { display: inline-flex; align-items: center; gap: 5px; padding: 3px 10px; border-radius: 20px; font-size: 12px; font-weight: 500; }
.badge-present { background: rgba(61,107,74,0.12); color: var(--ivy); }
.badge-absent { background: rgba(184,84,80,0.12); color: var(--accent-red); }
.badge-weekoff { background: rgba(212,160,23,0.12); color: var(--accent-amber); }
.badge-late { background: rgba(200,133,74,0.15); color: var(--caramel); }
.badge-break { background: rgba(107,63,42,0.1); color: var(--mocha); }
.btn { border: none; cursor: pointer; border-radius: 10px; font-family: 'DM Sans', sans-serif; font-weight: 500; transition: all 0.2s; display: inline-flex; align-items: center; gap: 6px; }
.btn-primary { background: var(--espresso); color: var(--cream); padding: 10px 20px; font-size: 14px; }
.btn-primary:hover { background: var(--mocha); }
.btn-ivy { background: var(--ivy); color: white; }
.btn-ivy:hover { background: #2D5438; }
.btn-sm { padding: 6px 14px; font-size: 12px; border-radius: 8px; }
.btn-outline { background: none; border: 1px solid var(--steam); color: var(--espresso); padding: 8px 16px; font-size: 13px; }
.btn-outline:hover { border-color: var(--caramel); color: var(--caramel); }
.btn-caramel { background: var(--caramel); color: white; }
.btn-green { background: var(--ivy); color: white; }
.btn-red { background: var(--accent-red); color: white; }
.form-group { margin-bottom: 16px; }
label { display: block; font-size: 11px; font-weight: 600; letter-spacing: 0.4px; text-transform: uppercase; color: var(--mocha); margin-bottom: 6px; }
input, select { width: 100%; background: var(--foam); border: 1px solid var(--steam); border-radius: 10px; padding: 10px 14px; font-family: 'DM Sans', sans-serif; font-size: 14px; color: var(--espresso); transition: border 0.2s; outline: none; }
input:focus, select:focus { border-color: var(--ivy); box-shadow: 0 0 0 3px rgba(61,107,74,0.1); }
.grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
.clock-section { background: linear-gradient(135deg, var(--espresso) 0%, #1E3A28 100%); border-radius: 20px; padding: 26px 30px; color: var(--cream); margin-bottom: 22px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 8px 32px rgba(26,15,10,0.25); position: relative; overflow: hidden; }
.clock-section::before { content: 'üçÉ'; position: absolute; right: 24px; top: 50%; transform: translateY(-50%); font-size: 80px; opacity: 0.06; }
.live-time { font-family: 'DM Mono', monospace; font-size: 46px; letter-spacing: 2px; color: var(--latte); line-height: 1; }
.live-date { font-size: 13px; color: rgba(232,221,208,0.7); margin-top: 5px; }
.clock-actions { display: flex; flex-direction: column; gap: 10px; align-items: flex-end; }
.announcement { background: linear-gradient(135deg, var(--ivy), #2D5438); color: var(--cream); border-radius: 14px; padding: 14px 18px; margin-bottom: 18px; display: flex; align-items: center; gap: 12px; box-shadow: 0 4px 16px rgba(61,107,74,0.25); }
.announcement-icon { font-size: 18px; flex-shrink: 0; }
.announcement-text { font-size: 14px; line-height: 1.5; }
.announcement-text strong { display: block; font-size: 11px; letter-spacing: 0.5px; text-transform: uppercase; opacity: 0.75; margin-bottom: 2px; }
.progress-bar { background: var(--steam); border-radius: 99px; height: 6px; overflow: hidden; margin-top: 6px; }
.progress-fill { height: 100%; border-radius: 99px; background: linear-gradient(90deg, var(--ivy), var(--ivy-light)); transition: width 0.5s ease; }
.log-entry { display: flex; align-items: center; gap: 12px; padding: 9px 0; border-bottom: 1px solid var(--steam); }
.log-entry:last-child { border-bottom: none; }
.log-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
.log-dot-green { background: var(--ivy); }
.log-dot-amber { background: var(--accent-amber); }
.log-info { flex: 1; }
.log-name { font-size: 14px; font-weight: 500; }
.log-detail { font-size: 12px; color: var(--mocha); }
.log-time { font-family: 'DM Mono', monospace; font-size: 12px; color: var(--caramel); }
.perf-row { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; }
.perf-name { width: 100px; font-size: 13px; font-weight: 500; flex-shrink: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.perf-bar-wrap { flex: 1; }
.perf-pct { width: 38px; text-align: right; font-family: 'DM Mono', monospace; font-size: 13px; color: var(--ivy); flex-shrink: 0; }
.filter-row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; margin-bottom: 18px; }
.filter-row select { width: auto; padding: 8px 14px; }
.modal-overlay { position: fixed; inset: 0; z-index: 200; background: rgba(26,15,10,0.6); backdrop-filter: blur(4px); display: none; align-items: center; justify-content: center; }
.modal-overlay.open { display: flex; animation: fadeIn 0.2s ease; }
.modal { background: var(--warm-white); border-radius: 20px; width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(26,15,10,0.3); }
.modal-header { padding: 20px 26px; border-bottom: 1px solid var(--steam); display: flex; align-items: center; justify-content: space-between; background: var(--foam); }
.modal-title { font-family: 'Playfair Display', serif; font-size: 19px; }
.modal-close { background: none; border: none; cursor: pointer; font-size: 18px; color: var(--mocha); padding: 4px 8px; border-radius: 6px; }
.modal-close:hover { background: var(--steam); }
.modal-body { padding: 26px; }
.time-val { font-family: 'DM Mono', monospace; font-size: 13px; }
.working-hrs { font-family: 'DM Mono', monospace; font-size: 13px; font-weight: 500; color: var(--ivy); }
.view-only-banner { background: linear-gradient(135deg, rgba(61,107,74,0.1), rgba(200,133,74,0.08)); border: 1px solid rgba(61,107,74,0.2); border-radius: 12px; padding: 12px 18px; display: flex; align-items: center; gap: 10px; margin-bottom: 18px; font-size: 13px; color: var(--mocha); }
.cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; margin-top: 10px; }
.cal-day-label { font-size: 10px; font-weight: 600; text-transform: uppercase; color: var(--mocha); text-align: center; padding: 3px; }
.cal-day { aspect-ratio: 1; border-radius: 7px; display: flex; align-items: center; justify-content: center; font-size: 11px; font-family: 'DM Mono', monospace; }
.cal-present { background: rgba(61,107,74,0.18); color: var(--ivy); }
.cal-absent { background: rgba(184,84,80,0.14); color: var(--accent-red); }
.cal-weekoff { background: rgba(212,160,23,0.12); color: var(--accent-amber); }
.cal-late { background: rgba(200,133,74,0.18); color: var(--caramel); }
.cal-empty { background: transparent; }
.cal-today { outline: 2px solid var(--ivy); outline-offset: 1px; }
::-webkit-scrollbar { width: 6px; height: 6px; }
::-webkit-scrollbar-track { background: var(--cream); }
::-webkit-scrollbar-thumb { background: var(--steam); border-radius: 99px; }
@media(max-width:768px) {
  nav { padding: 0 14px; } .logo-badge { display: none; }
  main { padding: 14px; } .grid-2 { grid-template-columns: 1fr; }
  .clock-section { flex-direction: column; gap: 16px; } .live-time { font-size: 36px; }
  .stats-grid { grid-template-columns: 1fr 1fr; }
}
</style>
</head>
<body>

<div id="loading-overlay">
  <div class="spinner"></div>
  <div class="loading-text" id="loading-text">Connecting to database...</div>
</div>

<div id="login-screen">
  <div class="login-box">
    <div class="login-logo">
      <div class="login-logo-icon">üçÉ</div>
      <div class="login-cafe-name">Trailing Ivy Caf√©</div>
      <div class="login-cafe-sub">Staff Attendance System</div>
    </div>
    <div class="role-tabs">
      <div class="role-tab active" onclick="selectRole('admin')" id="tab-admin">
        <span class="role-tab-icon">üîê</span>
        <div class="role-tab-name">Admin</div>
        <div class="role-tab-desc">Full access</div>
      </div>
      <div class="role-tab" onclick="selectRole('user')" id="tab-user">
        <span class="role-tab-icon">üëÅÔ∏è</span>
        <div class="role-tab-name">Viewer</div>
        <div class="role-tab-desc">View only</div>
      </div>
    </div>
    <div class="login-form">
      <div class="form-group"><label>Username</label><input type="text" id="login-username" placeholder="Enter username" autocomplete="off"></div>
      <div class="form-group"><label>Password</label><input type="password" id="login-password" placeholder="Enter password" onkeydown="if(event.key==='Enter')doLogin()"></div>
      <button class="login-btn" onclick="doLogin()">Sign In ‚Üí</button>
      <div class="login-error" id="login-error">‚ùå Incorrect username or password.</div>
    </div>
    <div class="login-hint"><strong>Admin:</strong> admin / admin123 &nbsp;|&nbsp; <strong>Viewer:</strong> viewer / view123</div>
  </div>
</div>

<div class="app" id="main-app" style="display:none;">
<nav>
  <div class="logo">üçÉ Trailing Ivy Caf√© <span class="logo-badge" id="role-badge">ADMIN</span></div>
  <div class="nav-tabs" id="nav-tabs"></div>
  <div class="nav-right">
    <div class="nav-user"><div class="user-avatar" id="nav-avatar">A</div><span id="nav-username">Admin</span></div>
    <button class="logout-btn" onclick="doLogout()">Sign Out</button>
  </div>
</nav>
<main>

<!-- ADMIN DASHBOARD -->
<div class="panel" id="panel-admin">
  <div class="page-header">
    <div><div class="page-title">Good Morning ‚òï</div><div class="page-subtitle">Admin Dashboard ‚Äî Full Access</div></div>
    <div class="date-badge" id="header-date">‚Äî</div>
  </div>
  <div class="announcement"><div class="announcement-icon">üéâ</div><div class="announcement-text"><strong>Announcement</strong>Welcome to Trailing Ivy Caf√© Attendance System! üçÉ</div></div>
  <div class="stats-grid">
    <div class="stat-card green"><div class="stat-label">Present Today</div><div class="stat-value" id="stat-present">‚Äî</div><div class="stat-sub">of <span id="stat-total">‚Äî</span> staff</div></div>
    <div class="stat-card red"><div class="stat-label">Absent</div><div class="stat-value" id="stat-absent">‚Äî</div></div>
    <div class="stat-card amber"><div class="stat-label">Week Off</div><div class="stat-value" id="stat-weekoff">‚Äî</div></div>
    <div class="stat-card"><div class="stat-label">Late Today</div><div class="stat-value" id="stat-late">‚Äî</div></div>
    <div class="stat-card"><div class="stat-label">Avg Hours</div><div class="stat-value" id="stat-avghrs">‚Äî</div></div>
  </div>
  <div class="grid-2">
    <div class="card"><div class="card-header"><div class="card-title">Today's Log</div><button class="btn btn-sm btn-ivy" onclick="openModal('modal-checkin')">+ Log Entry</button></div><div class="card-body" id="today-log"></div></div>
    <div class="card"><div class="card-header"><div class="card-title">On Break Now</div><span class="badge badge-late">Live</span></div><div class="card-body" id="break-log"></div></div>
  </div>
  <div class="card">
    <div class="card-header"><div class="card-title">Attendance Register</div><button class="btn btn-sm btn-outline" onclick="exportCSV()">‚¨á Export CSV</button></div>
    <div class="card-body"><div class="table-wrap"><table><thead><tr><th>ID</th><th>Name</th><th>Role</th><th>Check-In</th><th>Break</th><th>Check-Out</th><th>Status</th><th>Hrs</th><th>Edit</th></tr></thead><tbody id="attendance-tbody"></tbody></table></div></div>
  </div>
</div>

<!-- CHECK-IN -->
<div class="panel" id="panel-checkin">
  <div class="page-header"><div><div class="page-title">Time Terminal</div><div class="page-subtitle">Log check-in, breaks & check-out</div></div><div class="date-badge" id="checkin-date-badge">‚Äî</div></div>
  <div class="clock-section">
    <div><div class="live-time" id="live-clock">00:00:00</div><div class="live-date" id="live-date-text">Loading...</div></div>
    <div class="clock-actions">
      <select id="ci-staff-sel" style="background:rgba(255,255,255,0.1);border:1px solid rgba(245,239,228,0.2);color:var(--cream);border-radius:10px;padding:8px 14px;font-size:14px;outline:none;min-width:180px;"></select>
      <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end;">
        <button class="btn btn-sm btn-green" onclick="logAction('checkin')">‚úì Check-In</button>
        <button class="btn btn-sm btn-caramel" onclick="logAction('break-start')">‚è∏ Break</button>
        <button class="btn btn-sm btn-outline" style="color:var(--cream);border-color:rgba(245,239,228,0.3);" onclick="logAction('break-end')">‚ñ∂ Resume</button>
        <button class="btn btn-sm btn-red" onclick="logAction('checkout')">‚úó Check-Out</button>
      </div>
    </div>
  </div>
  <div class="card"><div class="card-header"><div class="card-title">Current Status</div></div><div class="card-body"><div id="status-cards" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(190px,1fr));gap:10px;"></div></div></div>
</div>

<!-- REPORTS -->
<div class="panel" id="panel-reports">
  <div class="page-header"><div><div class="page-title">Monthly Reports</div><div class="page-subtitle">Analytics & performance</div></div></div>
  <div class="filter-row">
    <select id="rpt-month" onchange="renderReports()"><option value="0">January</option><option value="1">February</option><option value="2">March</option><option value="3">April</option><option value="4">May</option><option value="5">June</option><option value="6">July</option><option value="7">August</option><option value="8">September</option><option value="9">October</option><option value="10">November</option><option value="11">December</option></select>
    <select id="rpt-year" onchange="renderReports()"><option>2025</option><option selected>2026</option></select>
    <button class="btn btn-sm btn-outline" onclick="exportCSV()">‚¨á Export</button>
  </div>
  <div class="stats-grid" id="rpt-stats"></div>
  <div class="grid-2">
    <div class="card"><div class="card-header"><div class="card-title">Attendance %</div></div><div class="card-body" id="perf-chart"></div></div>
    <div class="card"><div class="card-header"><div class="card-title">Monthly Summary</div></div><div class="card-body"><div class="table-wrap"><table><thead><tr><th>Name</th><th>Present</th><th>Absent</th><th>Late</th><th>Avg Hrs</th></tr></thead><tbody id="rpt-summary-tbody"></tbody></table></div></div></div>
  </div>
</div>

<!-- STAFF -->
<div class="panel" id="panel-staff">
  <div class="page-header"><div><div class="page-title">Staff Directory</div><div class="page-subtitle">Manage your team</div></div><button class="btn btn-primary" onclick="openModal('modal-add-staff')">+ Add Staff</button></div>
  <div class="card"><div class="card-body"><div class="table-wrap"><table><thead><tr><th>ID</th><th>Name</th><th>Role</th><th>Shift Start</th><th>Shift End</th><th>Week Off</th><th>Action</th></tr></thead><tbody id="staff-tbody"></tbody></table></div></div></div>
</div>

<!-- VIEWER -->
<div class="panel" id="panel-viewer">
  <div class="page-header"><div><div class="page-title">Staff Overview</div><div class="page-subtitle">Trailing Ivy Caf√© ‚Äî Viewer Dashboard</div></div><div class="date-badge" id="viewer-date">‚Äî</div></div>
  <div class="view-only-banner">üëÅÔ∏è <strong style="margin-right:4px;">View Only Mode</strong> ‚Äî You can see attendance data but cannot make changes.</div>
  <div class="announcement"><div class="announcement-icon">üì¢</div><div class="announcement-text"><strong>Notice</strong>Welcome to Trailing Ivy Caf√© Staff Overview! üçÉ</div></div>
  <div class="stats-grid" id="viewer-stats"></div>
  <div class="filter-row">
    <select id="view-month" onchange="renderViewer()"><option value="0">January</option><option value="1">February</option><option value="2">March</option><option value="3">April</option><option value="4">May</option><option value="5">June</option><option value="6">July</option><option value="7">August</option><option value="8">September</option><option value="9">October</option><option value="10">November</option><option value="11">December</option></select>
    <select id="view-staff" onchange="renderViewer()"><option value="all">All Staff</option></select>
  </div>
  <div id="viewer-cards" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(290px,1fr));gap:16px;"></div>
</div>

</main>
</div>

<!-- MODALS -->
<div class="modal-overlay" id="modal-checkin">
  <div class="modal">
    <div class="modal-header"><div class="modal-title">Log Attendance</div><button class="modal-close" onclick="closeModal('modal-checkin')">‚úï</button></div>
    <div class="modal-body">
      <div class="form-group"><label>Select Staff</label><select id="m-ci-staff"><option value="">‚Äî Choose ‚Äî</option></select></div>
      <div class="grid-2">
        <div class="form-group"><label>Date</label><input type="date" id="m-ci-date"></div>
        <div class="form-group"><label>Action</label><select id="m-ci-action"><option>Check-In</option><option>Break Start</option><option>Break End</option><option>Check-Out</option></select></div>
      </div>
      <div class="form-group"><label>Time (blank = now)</label><input type="time" id="m-ci-time"></div>
      <button class="btn btn-ivy" style="width:100%;padding:12px;" onclick="submitLog()">Submit Log</button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="modal-add-staff">
  <div class="modal">
    <div class="modal-header"><div class="modal-title">Add New Staff</div><button class="modal-close" onclick="closeModal('modal-add-staff')">‚úï</button></div>
    <div class="modal-body">
      <div class="grid-2">
        <div class="form-group"><label>Full Name</label><input type="text" id="s-name" placeholder="Staff name"></div>
        <div class="form-group"><label>Role</label><select id="s-role"><option>Barista</option><option>Cashier</option><option>Supervisor</option><option>Chef</option><option>Cafe Helper</option><option>Cleaner</option><option>Manager</option></select></div>
      </div>
      <div class="grid-2">
        <div class="form-group"><label>Shift Start</label><input type="time" id="s-shift-start" value="09:00"></div>
        <div class="form-group"><label>Shift End</label><input type="time" id="s-shift-end" value="18:00"></div>
      </div>
      <div class="form-group"><label>Week Off</label><select id="s-weekoff"><option>Monday</option><option>Tuesday</option><option>Wednesday</option><option>Thursday</option><option>Friday</option><option selected>Saturday</option><option>Sunday</option></select></div>
      <button class="btn btn-ivy" style="width:100%;padding:12px;" onclick="addStaff()">Add Staff Member</button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="modal-edit">
  <div class="modal">
    <div class="modal-header"><div class="modal-title">Edit Record</div><button class="modal-close" onclick="closeModal('modal-edit')">‚úï</button></div>
    <div class="modal-body" id="edit-modal-body"></div>
  </div>
</div>

<script>
const SUPABASE_URL = 'https://mmhjmgdyoejnktumhflz.supabase.co';
const SUPABASE_KEY = 'sb_publishable_wEoorrH4w8NHPZexsJvYWg_OZCrpi7r';
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let staffList = [];
let attendanceList = [];
let currentRole = null;
let selectedLoginRole = 'admin';
const today = new Date();
const todayStr = fmt(today);

function fmt(d){return d.toISOString().split('T')[0];}
function timeToMin(t){if(!t)return 0;const[h,m]=t.split(':');return +h*60+ +m;}
function nowTime(){const n=new Date();return `${String(n.getHours()).padStart(2,'0')}:${String(n.getMinutes()).padStart(2,'0')}`;}
function calcWorkingHrs(rec){
  if(!rec||!rec.check_in||!rec.check_out)return '‚Äî';
  let t=timeToMin(rec.check_out)-timeToMin(rec.check_in);
  if(rec.break_start&&rec.break_end)t-=timeToMin(rec.break_end)-timeToMin(rec.break_start);
  if(t<=0)return '‚Äî';
  return `${Math.floor(t/60)}h ${String(t%60).padStart(2,'0')}m`;
}
function workingHrsMin(rec){
  if(!rec||!rec.check_in||!rec.check_out)return 0;
  let t=timeToMin(rec.check_out)-timeToMin(rec.check_in);
  if(rec.break_start&&rec.break_end)t-=timeToMin(rec.break_end)-timeToMin(rec.break_start);
  return Math.max(0,t);
}
function getStaff(id){return staffList.find(s=>s.id===id)||{};}
function getTodayRec(id){return attendanceList.find(a=>a.date===todayStr&&a.staff_id===id);}
function openModal(id){document.getElementById(id).classList.add('open');}
function closeModal(id){document.getElementById(id).classList.remove('open');}
function showLoading(text='Saving...'){document.getElementById('loading-text').textContent=text;document.getElementById('loading-overlay').classList.add('show');}
function hideLoading(){document.getElementById('loading-overlay').classList.remove('show');}
function statusBadge(s){
  const map={Present:'badge-present',Absent:'badge-absent','Week Off':'badge-weekoff',Late:'badge-late'};
  const dot={Present:'üü¢',Absent:'üî¥','Week Off':'üü°',Late:'üü†'};
  return `<span class="badge ${map[s]||'badge-break'}">${dot[s]||'‚ö™'} ${s||'‚Äî'}</span>`;
}

function updateClock(){
  const n=new Date();
  const ts=n.toLocaleTimeString('en-IN',{hour12:false});
  const ds=n.toLocaleDateString('en-IN',{weekday:'long',year:'numeric',month:'long',day:'numeric'});
  const sd=n.toLocaleDateString('en-IN',{day:'2-digit',month:'short',year:'numeric'});
  ['live-clock'].forEach(id=>{const el=document.getElementById(id);if(el)el.textContent=ts;});
  ['live-date-text'].forEach(id=>{const el=document.getElementById(id);if(el)el.textContent=ds;});
  ['header-date','checkin-date-badge','viewer-date'].forEach(id=>{const el=document.getElementById(id);if(el)el.textContent=sd;});
}
setInterval(updateClock,1000);updateClock();

const CREDENTIALS={admin:{pass:'admin123',role:'admin'},viewer:{pass:'view123',role:'user'}};

function selectRole(r){
  selectedLoginRole=r;
  document.getElementById('tab-admin').classList.toggle('active',r==='admin');
  document.getElementById('tab-user').classList.toggle('active',r==='user');
  document.getElementById('login-error').style.display='none';
}

async function doLogin(){
  const u=document.getElementById('login-username').value.trim().toLowerCase();
  const p=document.getElementById('login-password').value;
  const err=document.getElementById('login-error');
  const cred=CREDENTIALS[u];
  if(!cred||cred.pass!==p||cred.role!==selectedLoginRole){err.style.display='block';return;}
  err.style.display='none';
  currentRole=cred.role;
  showLoading('Loading data...');
  await loadAllData();
  hideLoading();
  document.getElementById('login-screen').style.display='none';
  document.getElementById('main-app').style.display='flex';
  document.getElementById('main-app').style.flexDirection='column';
  setupApp();
}

function doLogout(){
  currentRole=null;
  document.getElementById('login-screen').style.display='flex';
  document.getElementById('main-app').style.display='none';
  document.getElementById('login-username').value='';
  document.getElementById('login-password').value='';
  document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
}

async function loadAllData(){
  const[staffRes,attRes]=await Promise.all([sb.from('staff').select('*'),sb.from('attendance').select('*')]);
  if(staffRes.data)staffList=staffRes.data;
  if(attRes.data)attendanceList=attRes.data;
}

async function loadAttendance(){
  const{data}=await sb.from('attendance').select('*');
  if(data)attendanceList=data;
}

function setupApp(){
  const isAdmin=currentRole==='admin';
  document.getElementById('role-badge').textContent=isAdmin?'ADMIN':'VIEWER';
  document.getElementById('nav-avatar').textContent=isAdmin?'A':'V';
  document.getElementById('nav-username').textContent=isAdmin?'Admin':'Viewer';
  const navTabs=document.getElementById('nav-tabs');
  if(isAdmin){
    navTabs.innerHTML=`
      <button class="nav-tab active" onclick="showPanel('admin',this)">Dashboard</button>
      <button class="nav-tab" onclick="showPanel('checkin',this)">Check-In</button>
      <button class="nav-tab" onclick="showPanel('reports',this)">Reports</button>
      <button class="nav-tab" onclick="showPanel('staff',this)">Staff</button>`;
    showPanel('admin',navTabs.firstElementChild);
  }else{
    navTabs.innerHTML=`<button class="nav-tab active" onclick="showPanel('viewer',this)">Overview</button>`;
    showPanel('viewer',navTabs.firstElementChild);
  }
  populateStaffSelects();
  setMonthFilters();
  document.getElementById('m-ci-date').value=todayStr;
}

function showPanel(name,btn){
  document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.nav-tab').forEach(t=>t.classList.remove('active'));
  const panel=document.getElementById('panel-'+name);
  if(panel)panel.classList.add('active');
  if(btn)btn.classList.add('active');
  if(name==='admin')renderAdmin();
  if(name==='checkin')renderCheckin();
  if(name==='reports')renderReports();
  if(name==='staff')renderStaff();
  if(name==='viewer')renderViewer();
}

function populateStaffSelects(){
  const opts=staffList.map(s=>`<option value="${s.id}">${s.name} (${s.id})</option>`).join('');
  ['m-ci-staff','ci-staff-sel'].forEach(id=>{const el=document.getElementById(id);if(el){const cur=el.value;el.innerHTML='<option value="">‚Äî Select ‚Äî</option>'+opts;if(cur)el.value=cur;}});
  const vs=document.getElementById('view-staff');
  if(vs)vs.innerHTML='<option value="all">All Staff</option>'+staffList.map(s=>`<option value="${s.id}">${s.name}</option>`).join('');
}

function setMonthFilters(){
  const m=new Date().getMonth();
  ['rpt-month','view-month'].forEach(id=>{const el=document.getElementById(id);if(el)el.value=m;});
}

function renderAdmin(){
  const recs=attendanceList.filter(a=>a.date===todayStr);
  let present=0,absent=0,weekoff=0,late=0,totalHrs=0,hrsCount=0;
  staffList.forEach(s=>{
    const r=recs.find(x=>x.staff_id===s.id);
    if(!r||r.status==='Absent')absent++;
    else if(r.status==='Week Off')weekoff++;
    else{present++;if(r.status==='Late')late++;}
    const wh=r?workingHrsMin(r):0;
    if(wh>0){totalHrs+=wh;hrsCount++;}
  });
  document.getElementById('stat-present').textContent=present;
  document.getElementById('stat-absent').textContent=absent;
  document.getElementById('stat-weekoff').textContent=weekoff;
  document.getElementById('stat-late').textContent=late;
  document.getElementById('stat-total').textContent=staffList.length;
  const avg=hrsCount?Math.floor(totalHrs/hrsCount/60)+'h '+Math.floor(totalHrs/hrsCount)%60+'m':'‚Äî';
  document.getElementById('stat-avghrs').textContent=avg;
  document.getElementById('today-log').innerHTML=recs.filter(r=>r.check_in).map(r=>{
    const s=getStaff(r.staff_id);
    return `<div class="log-entry"><div class="log-dot ${r.status==='Late'?'log-dot-amber':'log-dot-green'}"></div><div class="log-info"><div class="log-name">${s.name}</div><div class="log-detail">${s.role} ¬∑ ${r.status}</div></div><div class="log-time">${r.check_in}</div></div>`;
  }).join('')||'<div style="color:var(--mocha);font-size:13px;">No check-ins yet.</div>';
  const onBreak=recs.filter(r=>r.break_start&&!r.break_end&&!r.check_out);
  document.getElementById('break-log').innerHTML=onBreak.length?onBreak.map(r=>{
    const s=getStaff(r.staff_id);
    return `<div class="log-entry"><div class="log-dot log-dot-amber"></div><div class="log-info"><div class="log-name">${s.name}</div><div class="log-detail">Since ${r.break_start}</div></div><div class="log-time">‚è∏</div></div>`;
  }).join(''):'<div style="color:var(--mocha);font-size:13px;">No one on break.</div>';
  document.getElementById('attendance-tbody').innerHTML=staffList.map(s=>{
    const r=recs.find(x=>x.staff_id===s.id)||{};
    return `<tr><td class="time-val">${s.id}</td><td><strong>${s.name}</strong></td><td style="color:var(--mocha)">${s.role}</td><td class="time-val">${r.check_in||'‚Äî'}</td><td class="time-val">${r.break_start?(r.break_end?r.break_start+' ‚Äì '+r.break_end:r.break_start+' ‚è∏'):'-'}</td><td class="time-val">${r.check_out||'‚Äî'}</td><td>${statusBadge(r.status||'Absent')}</td><td><span class="working-hrs">${calcWorkingHrs(r)}</span></td><td><button class="btn btn-sm btn-outline" onclick="editRecord('${s.id}')">Edit</button></td></tr>`;
  }).join('');
  populateStaffSelects();
}

function renderCheckin(){
  populateStaffSelects();
  document.getElementById('status-cards').innerHTML=staffList.map(s=>{
    const r=getTodayRec(s.id)||{};
    let txt='Not Checked In',bg='rgba(107,63,42,0.06)',tc='var(--mocha)';
    if(r.check_in&&!r.check_out){txt='Working';bg='rgba(61,107,74,0.12)';tc='var(--ivy)';}
    if(r.break_start&&!r.break_end){txt='On Break';bg='rgba(212,160,23,0.1)';tc='var(--accent-amber)';}
    if(r.check_out){txt='Checked Out';bg='rgba(107,63,42,0.06)';tc='var(--mocha)';}
    if(r.status==='Week Off'){txt='Week Off';bg='rgba(212,160,23,0.08)';tc='var(--accent-amber)';}
    return `<div style="background:${bg};border:1px solid var(--steam);border-radius:12px;padding:14px;"><div style="font-size:13px;font-weight:600;">${s.name}</div><div style="font-size:11px;color:var(--mocha);margin-bottom:6px;">${s.role}</div><div style="font-size:12px;font-weight:600;color:${tc};">${txt}</div>${r.check_in?`<div class="time-val" style="font-size:11px;color:var(--mocha);margin-top:3px;">In: ${r.check_in}${r.check_out?' | Out: '+r.check_out:''}</div>`:''}</div>`;
  }).join('');
}

async function logAction(action){
  const staffId=document.getElementById('ci-staff-sel').value;
  if(!staffId){alert('Please select a staff member first.');return;}
  const now=nowTime();
  const s=getStaff(staffId);
  let rec=attendanceList.find(a=>a.date===todayStr&&a.staff_id===staffId);
  showLoading('Saving...');
  if(!rec){
    const{data}=await sb.from('attendance').insert([{date:todayStr,staff_id:staffId,check_in:'',break_start:'',break_end:'',check_out:'',status:'Present',notes:''}]).select();
    if(data){rec=data[0];attendanceList.push(rec);}
  }
  const updates={};
  if(action==='checkin'){
    if(rec.check_in){hideLoading();alert('Already checked in at '+rec.check_in);return;}
    updates.check_in=now;updates.status=timeToMin(now)>timeToMin(s.shift_start)+15?'Late':'Present';
  }else if(action==='break-start'){
    if(!rec.check_in){hideLoading();alert('Not checked in yet.');return;}
    updates.break_start=now;updates.break_end='';
  }else if(action==='break-end'){
    if(!rec.break_start){hideLoading();alert('No active break.');return;}
    updates.break_end=now;
  }else if(action==='checkout'){
    if(!rec.check_in){hideLoading();alert('Not checked in yet.');return;}
    updates.check_out=now;
  }
  await sb.from('attendance').update(updates).eq('date',todayStr).eq('staff_id',staffId);
  await loadAttendance();
  hideLoading();
  renderCheckin();renderAdmin();
}

async function submitLog(){
  const staffId=document.getElementById('m-ci-staff').value;
  const date=document.getElementById('m-ci-date').value;
  const action=document.getElementById('m-ci-action').value;
  const time=document.getElementById('m-ci-time').value||nowTime();
  if(!staffId||!date){alert('Please fill all fields.');return;}
  showLoading('Saving...');
  let rec=attendanceList.find(a=>a.date===date&&a.staff_id===staffId);
  if(!rec){
    const{data}=await sb.from('attendance').insert([{date,staff_id:staffId,check_in:'',break_start:'',break_end:'',check_out:'',status:'Present',notes:''}]).select();
    if(data){rec=data[0];attendanceList.push(rec);}
  }
  const updates={};
  const s=getStaff(staffId);
  if(action==='Check-In'){updates.check_in=time;updates.status=timeToMin(time)>timeToMin(s.shift_start)+15?'Late':'Present';}
  else if(action==='Break Start')updates.break_start=time;
  else if(action==='Break End')updates.break_end=time;
  else if(action==='Check-Out')updates.check_out=time;
  await sb.from('attendance').update(updates).eq('date',date).eq('staff_id',staffId);
  await loadAttendance();
  hideLoading();closeModal('modal-checkin');renderAdmin();
}

function editRecord(staffId){
  const rec=attendanceList.find(a=>a.date===todayStr&&a.staff_id===staffId)||{staff_id:staffId,date:todayStr,check_in:'',break_start:'',break_end:'',check_out:'',status:'Present'};
  const s=getStaff(staffId);
  document.getElementById('edit-modal-body').innerHTML=`
    <p style="font-size:14px;font-weight:600;margin-bottom:16px;">${s.name} ‚Äî ${todayStr}</p>
    <div class="grid-2">
      <div class="form-group"><label>Check-In</label><input type="time" id="e-ci" value="${rec.check_in||''}"></div>
      <div class="form-group"><label>Check-Out</label><input type="time" id="e-co" value="${rec.check_out||''}"></div>
      <div class="form-group"><label>Break Start</label><input type="time" id="e-bs" value="${rec.break_start||''}"></div>
      <div class="form-group"><label>Break End</label><input type="time" id="e-be" value="${rec.break_end||''}"></div>
    </div>
    <div class="form-group"><label>Status</label><select id="e-status">${['Present','Absent','Late','Week Off'].map(v=>`<option ${rec.status===v?'selected':''}>${v}</option>`).join('')}</select></div>
    <button class="btn btn-ivy" style="width:100%;padding:12px;" onclick="saveEdit('${staffId}')">Save Changes</button>`;
  openModal('modal-edit');
}

async function saveEdit(staffId){
  const updates={check_in:document.getElementById('e-ci').value,check_out:document.getElementById('e-co').value,break_start:document.getElementById('e-bs').value,break_end:document.getElementById('e-be').value,status:document.getElementById('e-status').value};
  showLoading('Saving...');
  const existing=attendanceList.find(a=>a.date===todayStr&&a.staff_id===staffId);
  if(existing)await sb.from('attendance').update(updates).eq('date',todayStr).eq('staff_id',staffId);
  else await sb.from('attendance').insert([{date:todayStr,staff_id:staffId,...updates,notes:''}]);
  await loadAttendance();
  hideLoading();closeModal('modal-edit');renderAdmin();
}

function renderReports(){
  const month=+document.getElementById('rpt-month').value;
  const year=+document.getElementById('rpt-year').value;
  const dim=new Date(year,month+1,0).getDate();
  const recs=attendanceList.filter(a=>{const d=new Date(a.date);return d.getMonth()===month&&d.getFullYear()===year;});
  let tp=0,ta=0,tl=0;
  const rows=staffList.map(s=>{
    const sr=recs.filter(r=>r.staff_id===s.id);
    const present=sr.filter(r=>r.status==='Present'||r.status==='Late').length;
    const absent=sr.filter(r=>r.status==='Absent').length;
    const late=sr.filter(r=>r.status==='Late').length;
    const hrs=sr.reduce((a,r)=>a+workingHrsMin(r),0);
    const avg=present?Math.floor(hrs/present/60)+'h '+Math.floor(hrs/present)%60+'m':'‚Äî';
    tp+=present;ta+=absent;tl+=late;
    return{s,present,absent,late,avg,pct:Math.round(present/Math.max(dim,1)*100)};
  });
  document.getElementById('rpt-stats').innerHTML=`
    <div class="stat-card green"><div class="stat-label">Total Present</div><div class="stat-value">${tp}</div></div>
    <div class="stat-card red"><div class="stat-label">Total Absent</div><div class="stat-value">${ta}</div></div>
    <div class="stat-card amber"><div class="stat-label">Late Arrivals</div><div class="stat-value">${tl}</div></div>
    <div class="stat-card"><div class="stat-label">Avg Attendance</div><div class="stat-value">${Math.round(tp/(staffList.length*dim||1)*100)}%</div></div>`;
  document.getElementById('perf-chart').innerHTML=rows.map(({s,pct})=>`<div class="perf-row"><div class="perf-name">${s.name.split(' ')[0]}</div><div class="perf-bar-wrap"><div class="progress-bar"><div class="progress-fill" style="width:${pct}%"></div></div></div><div class="perf-pct">${pct}%</div></div>`).join('');
  document.getElementById('rpt-summary-tbody').innerHTML=rows.map(({s,present,absent,late,avg})=>`<tr><td><strong>${s.name}</strong></td><td>${present}</td><td>${absent}</td><td>${late?`<span style="color:var(--caramel)">${late}</span>`:'0'}</td><td class="time-val">${avg}</td></tr>`).join('');
}

function renderViewer(){
  populateStaffSelects();
  const month=+document.getElementById('view-month').value;
  const year=new Date().getFullYear();
  const filter=document.getElementById('view-staff').value;
  const dim=new Date(year,month+1,0).getDate();
  const filtered=filter==='all'?staffList:staffList.filter(s=>s.id===filter);
  const allRecs=attendanceList.filter(a=>{const d=new Date(a.date);return d.getMonth()===month&&d.getFullYear()===year;});
  let tp=0,ta=0,two=0;
  filtered.forEach(s=>{
    const sr=allRecs.filter(r=>r.staff_id===s.id);
    tp+=sr.filter(r=>r.status==='Present'||r.status==='Late').length;
    ta+=sr.filter(r=>r.status==='Absent').length;
    two+=sr.filter(r=>r.status==='Week Off').length;
  });
  document.getElementById('viewer-stats').innerHTML=`
    <div class="stat-card green"><div class="stat-label">Present Days</div><div class="stat-value">${tp}</div></div>
    <div class="stat-card red"><div class="stat-label">Absent Days</div><div class="stat-value">${ta}</div></div>
    <div class="stat-card amber"><div class="stat-label">Week Offs</div><div class="stat-value">${two}</div></div>
    <div class="stat-card"><div class="stat-label">Staff Shown</div><div class="stat-value">${filtered.length}</div></div>`;
  document.getElementById('viewer-cards').innerHTML=filtered.map(s=>{
    const recs=allRecs.filter(r=>r.staff_id===s.id);
    const present=recs.filter(r=>r.status==='Present'||r.status==='Late').length;
    const absent=recs.filter(r=>r.status==='Absent').length;
    const weekoff=recs.filter(r=>r.status==='Week Off').length;
    const hrs=recs.reduce((a,r)=>a+workingHrsMin(r),0);
    const avgH=present?Math.floor(hrs/present/60)+'h '+Math.floor(hrs/present)%60+'m':'‚Äî';
    const pct=Math.round(present/Math.max(dim-weekoff,1)*100);
    const firstDay=new Date(year,month,1).getDay();
    const days=['S','M','T','W','T','F','S'];
    let cal=days.map(d=>`<div class="cal-day-label">${d}</div>`).join('');
    for(let i=0;i<firstDay;i++)cal+=`<div class="cal-empty"></div>`;
    for(let d=1;d<=dim;d++){
      const ds=`${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
      const r=recs.find(x=>x.date===ds);
      const isToday=ds===todayStr;
      let cls='cal-empty';
      if(r){if(r.status==='Present')cls='cal-present';else if(r.status==='Late')cls='cal-late';else if(r.status==='Absent')cls='cal-absent';else if(r.status==='Week Off')cls='cal-weekoff';}
      cal+=`<div class="cal-day ${cls}${isToday?' cal-today':''}">${d}</div>`;
    }
    return `<div class="card">
      <div class="card-header" style="flex-direction:column;align-items:flex-start;gap:6px;">
        <div style="display:flex;align-items:center;justify-content:space-between;width:100%;">
          <div><div class="card-title">${s.name}</div><div style="font-size:12px;color:var(--mocha);">${s.role} ¬∑ ${s.id}</div></div>
          <div style="text-align:right;"><div style="font-family:'DM Mono',monospace;font-size:24px;color:var(--ivy);font-weight:600;">${pct}%</div><div style="font-size:11px;color:var(--mocha);">Attendance</div></div>
        </div>
        <div style="width:100%;"><div class="progress-bar"><div class="progress-fill" style="width:${pct}%"></div></div></div>
      </div>
      <div class="card-body">
        <div style="display:flex;gap:10px;margin-bottom:14px;">
          <div style="flex:1;text-align:center;padding:10px;background:rgba(61,107,74,0.08);border-radius:10px;"><div style="font-family:'Playfair Display',serif;font-size:20px;color:var(--ivy);">${present}</div><div style="font-size:11px;color:var(--mocha);">Present</div></div>
          <div style="flex:1;text-align:center;padding:10px;background:rgba(184,84,80,0.08);border-radius:10px;"><div style="font-family:'Playfair Display',serif;font-size:20px;color:var(--accent-red);">${absent}</div><div style="font-size:11px;color:var(--mocha);">Absent</div></div>
          <div style="flex:1;text-align:center;padding:10px;background:rgba(212,160,23,0.08);border-radius:10px;"><div style="font-family:'Playfair Display',serif;font-size:20px;color:var(--accent-amber);">${weekoff}</div><div style="font-size:11px;color:var(--mocha);">Week Off</div></div>
        </div>
        <div style="font-size:12px;color:var(--mocha);margin-bottom:10px;">Avg Working Hrs: <strong>${avgH}</strong></div>
        <div class="cal-grid">${cal}</div>
      </div>
    </div>`;
  }).join('');
}

function renderStaff(){
  document.getElementById('staff-tbody').innerHTML=staffList.map(s=>`
    <tr><td class="time-val">${s.id}</td><td><strong>${s.name}</strong></td><td><span class="badge badge-break">${s.role}</span></td><td class="time-val">${s.shift_start}</td><td class="time-val">${s.shift_end}</td><td>${s.week_off}</td>
    <td><button class="btn btn-sm btn-outline" style="color:var(--accent-red);border-color:rgba(184,84,80,0.3);" onclick="removeStaff('${s.id}')">Remove</button></td></tr>`).join('');
}

async function addStaff(){
  const name=document.getElementById('s-name').value.trim();
  if(!name){alert('Please enter a name.');return;}
  const id='TI'+String(staffList.length+1).padStart(3,'0');
  const newStaff={id,name,role:document.getElementById('s-role').value,shift_start:document.getElementById('s-shift-start').value,shift_end:document.getElementById('s-shift-end').value,week_off:document.getElementById('s-weekoff').value};
  showLoading('Adding staff...');
  await sb.from('staff').insert([newStaff]);
  staffList.push(newStaff);
  document.getElementById('s-name').value='';
  hideLoading();closeModal('modal-add-staff');renderStaff();renderAdmin();populateStaffSelects();
}

async function removeStaff(id){
  if(!confirm('Remove this staff member?'))return;
  showLoading('Removing...');
  await sb.from('staff').delete().eq('id',id);
  staffList=staffList.filter(s=>s.id!==id);
  hideLoading();renderStaff();renderAdmin();
}

function exportCSV(){
  const headers=['Date','Staff ID','Name','Role','Check-In','Break Start','Break End','Check-Out','Status','Working Hrs'];
  const rows=attendanceList.map(r=>{const s=getStaff(r.staff_id);return[r.date,r.staff_id,s.name,s.role,r.check_in,r.break_start,r.break_end,r.check_out,r.status,calcWorkingHrs(r)];});
  const csv=[headers,...rows].map(r=>r.join(',')).join('\n');
  const a=document.createElement('a');a.href='data:text/csv;charset=utf-8,'+encodeURIComponent(csv);
  a.download=`trailing-ivy-attendance-${todayStr}.csv`;a.click();
}

document.querySelectorAll('.modal-overlay').forEach(el=>{
  el.addEventListener('click',e=>{if(e.target===el)el.classList.remove('open');});
});
</script>
</body>
</html>
